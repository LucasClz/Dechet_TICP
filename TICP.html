<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>TICP • Localisation Déchets (GPS FIX) + Fusion tournées</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ExcelJS pour lire les .xlsx -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

<style>

  .crit .checks{display:flex;gap:8px}
  .checks input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  .checks.labeled{display:grid;grid-template-rows:auto auto;gap:6px}
  .checks.labeled .letters{display:grid;grid-template-columns:repeat(4, minmax(18px,auto));gap:8px;align-items:end}
  .checks.labeled .letters span{display:block;text-align:center;font-weight:700;font-size:12px;color:#374151}
  .checks.labeled .boxes{display:grid;grid-template-columns:repeat(4, minmax(18px,auto));gap:8px;align-items:start}


  :root{--brand:#E6007E;--brand-700:#b80063;--bg:#f6f7fb;--panel:#fff;--text:#1f2a37;--muted:#6b7280;--line:#e5e7eb}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}

  .app{display:grid;grid-template-rows:auto 1fr;height:100%}
  header.appbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
  .bar{max-width:1600px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo{width:10px;height:28px;border-radius:999px;background:var(--brand);box-shadow:0 0 0 6px rgba(230,0,126,.08)}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#eef2ff;color:#3730a3}
  .btn{appearance:none;border:none;border-radius:10px;cursor:pointer;padding:10px 14px;font-weight:600;background:var(--brand);color:#fff;box-shadow:0 8px 22px rgba(230,0,126,.22);transition:.2s}
  .btn:hover{background:var(--brand-700);transform:translateY(-1px)}
  .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:8px 10px;border-radius:8px;font-size:12px}
  .btn.toggle.on{background:#111827;color:#fff;box-shadow:none}
  .btn.danger{background:#ef4444;color:#fff;border:1px solid #ef4444}
  .btn.danger:hover{background:#dc2626}

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:0 0 16px 16px;box-shadow:0 10px 30px rgba(2,8,23,.06);margin:0 0 12px 0}
  .panel>header{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .panel>.content{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .field{display:grid;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,.choices__inner{width:100%}

  /* Carte */
  .mapwrap{position:relative;width:100%;background:#0b1020}
  .mapimg{position:absolute;left:0;top:0;user-select:none;-webkit-user-drag:none}
  canvas#overlay{position:absolute;left:0;top:0;pointer-events:none}

  .toolbox{position:absolute;left:12px;top:12px;z-index:5;display:flex;gap:8px;flex-wrap:wrap}
  .hud{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px;z-index:5}
  .card{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:170px;color:#111827}
  .kpi{font-size:12px;color:#6b7280;display:flex;gap:6px;align-items:center}
  .kpi strong{font-size:13px;color:#111827}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999}
  .toast.show{opacity:1}

  @media (min-width:1025px){
    .mapwrap{height:calc(100vh - 64px)}
    .panel{
      position:fixed; inset:64px 0 0 auto;
      width:380px; max-width:92vw; border-radius:0;
      transform:translateX(100%); transition:transform .25s ease;
      border-left:1px solid var(--line); border-right:none; margin:0;
      z-index:40; box-shadow:-20px 0 50px rgba(2,8,23,.15);
    }
    .panel.open{ transform:translateX(0) }
    .panel .close{ display:inline-flex }
  }
  @media (max-width:1024px){
    .mapwrap{height:70vh;min-height:520px;border-radius:16px}
    .panel .close{ display:none }
  }

  /* Modals */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,8,23,.42);backdrop-filter:blur(2px);display:none;z-index:60}
  .modal{position:fixed;right:0;top:0;height:100%;width:min(560px,94vw);background:#fff;border-left:1px solid var(--line);box-shadow:-20px 0 60px rgba(2,8,23,.25);transform:translateX(100%);transition:transform .25s ease;z-index:70;display:flex;flex-direction:column}
  .modal.open + .modal-backdrop{display:block}
  .modal.open{transform:translateX(0)}
  .modal header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .modal .content{padding:14px 16px;overflow:auto;flex:1}

  .crit{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .crit .checks{display:flex;gap:8px}
  .crit small{color:var(--muted)}
  .checks input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}

  /* Galerie photos */
  .photos-grid{display:grid;gap:10px;margin-top:6px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .photo-card{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;display:grid;gap:8px}
  .photo-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;background:#f3f4f6;cursor:pointer;transition:transform .2s}
  .photo-card img:hover{transform:scale(1.05)}
  .photo-card textarea{width:100%;min-height:58px;resize:vertical}
  .photo-card .row{justify-content:space-between}
  .photo-actions .btn.small{padding:6px 8px}

  /* Stats */
  .modal.stats{width:min(780px,96vw)}
  .barrow{display:grid;grid-template-columns:120px 1fr 54px;gap:8px;align-items:center}
  .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#10b981,#3b82f6)}
  .table{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .table header,.table .row{display:grid;grid-template-columns:80px 80px 80px 1fr 80px;gap:8px;padding:8px 10px}
  .table header{background:#f3f4f6;font-weight:600}
  .table .row:nth-child(even){background:#fafafa}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:100}
  .lightbox img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,.6);transform-origin:center}
  .lightbox .toolbar{position:absolute;top:16px;left:16px;display:flex;gap:8px}
  .lightbox .close{position:absolute;top:16px;right:16px}
</style>
<script>

/* ===== IDB (photos) ===== */
const DB_NAME = 'ticp-prm6';
const DB_VER  = 1;
let dbPromise = null;
function openDB(){
  if (dbPromise) return dbPromise;
  dbPromise = new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains('photos')){
        db.createObjectStore('photos', { keyPath: 'key' }); // { key, zone, ts, dataUrl, comment }
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror  = ()=> reject(req.error);
  });
  return dbPromise;
}
async function idbSet(store, obj){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(obj);
    tx.oncomplete = ()=> res();
    tx.onerror   = ()=> rej(tx.error);
  });
}
async function idbGet(store, key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store, 'readonly');
    const rq = tx.objectStore(store).get(key);
    rq.onsuccess = ()=> res(rq.result||null);
    rq.onerror   = ()=> rej(rq.error);
  });
}
async function idbGetMany(store, keys){
  const out=[]; for(const k of keys){ const v=await idbGet(store,k); if(v) out.push(v); } return out;
}

</script>
<style>
/* === SAMI (copié de PRM6) === */
  .checks.labeled{display:grid;grid-template-rows:auto auto;gap:6px}
  .checks.labeled .letters{display:grid;grid-template-columns:repeat(4, minmax(18px,auto));gap:8px;align-items:end}
  .checks.labeled .letters span{display:block;text-align:center;font-weight:700;font-size:12px;color:#374151}
  .checks.labeled .boxes{display:grid;grid-template-columns:repeat(4, minmax(18px,auto));gap:8px;align-items:start}

  /* Galerie photos */
  .photos-grid{display:grid;gap:10px;margin-top:6px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .photo-card{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;display:grid;gap:8px}
  .photo-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;background:#f3f4f6;cursor:pointer;transition:transform .2s}
  .photo-card img:hover{transform:scale(1.05)}
  .photo-card textarea{width:100%;min-height:58px;resize:vertical}
  .photo-card .row{justify-content:space-between}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="bar">
      <div class="brand"><div class="logo"></div>TICP • Localisation des déchets</div>
      <div class="row">
        <button class="btn secondary small" id="btnTogglePanel">Panneau</button>
        <button class="btn secondary small" id="btnOpenStats">Graphiques</button>

        <!-- Import fusion -->
        <label class="btn secondary small" for="fileImport" title="Importer et fusionner des tournées (.xlsx/.xls)">Importer</label>
        <input id="fileImport" type="file" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" multiple style="display:none"/>

        <button class="btn secondary small" id="btnExportXls" title="Exporter la tournée au format .xls">Exporter XLS</button>
        <button class="btn danger small" id="btnResetAll" title="Tout remettre à zéro">Réinitialiser</button>
        <span class="chip" id="chipGps">GPS: off</span>
        <span class="chip" id="chipCompass">Boussole: off</span>
      </div>
    </div>
  </header>

  <main>
    <section class="panel" id="panel">
      <header>
        Navigation & Recherche
        <button class="btn secondary small close" id="btnClosePanel" style="display:none">Fermer</button>
      </header>
      <div class="content grid">
        <div class="field">
          <label>Origine</label>
          <div class="row">
            <button class="btn small" id="btnGPS">Activer GPS + Boussole</button>
            <button class="btn secondary small" id="btnPick">Choisir sur le plan</button>
            <button class="btn secondary small" id="btnCalibrate">Calibrer boussole</button>
            <button class="btn secondary small" id="btnNudgeMinus">-5°</button>
            <button class="btn secondary small" id="btnNudgePlus">+5°</button>
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="zoneSelect">Emplacement</label>
            <select id="zoneSelect" placeholder="Rechercher un emplacement"></select>
          </div>
          <div class="field">
            <label for="dechetSelect">Déchet</label>
            <select id="dechetSelect" placeholder="Rechercher un déchet"></select>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnOK">Tracer</button>
          <button class="btn secondary" id="btnClear">Effacer</button>
        </div>

        <div class="field">
          <label>Déchets dans la zone</label>
          <ul id="dechetList" style="padding-left:18px;margin:6px 0 0 0"><li>Aucune zone sélectionnée</li></ul>
        </div>
        <div class="muted">Astuce : cliquez directement une zone (ex. Z5) sur la carte pour ouvrir sa fiche.</div>
      </div>
    </section>

    <section class="mapwrap" id="mapContainer">
      <img id="mapImage" class="mapimg" src="TICP.png" alt="Plan du site" draggable="false"/>
      <canvas id="overlay"></canvas>

      <div class="toolbox">
        <button class="btn secondary small" id="zMinus">–</button>
        <button class="btn secondary small" id="zReset">100%</button>
        <button class="btn secondary small" id="zPlus">+</button>
        <button class="btn secondary small" id="btnFit">Ajuster</button>
      </div>

      <div class="hud">
        <div class="card">
          <div class="kpi">Position <strong id="kpiPos">—</strong></div>
          <div class="kpi">Cap <strong id="kpiHead">—</strong></div>
          <div class="kpi">Zoom <strong id="kpiZoom">100%</strong></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL FICHE -->
<section class="modal" id="zoneModal" aria-hidden="true">
  <header>
    <div>
      <div id="zoneTitle" style="font-weight:700">Fiche zone</div>
      <div id="zoneSubtitle" class="muted"></div>
    </div>
    <div class="row">
      <button class="btn secondary small toggle" id="btnGravite" title="Divise la note finale par 5 si activé">Gravité</button>
      <span class="chip" id="scoreChip">Total : 0 / 100</span>
      <button class="btn secondary small" id="btnCloseModal">Fermer</button>
    </div>
  </header>
  <div class="content grid" id="formContainer">
    <div class="crit"><div>Propreté de la zone<br/><small>sur 10 points</small></div>
      <div class="checks labeled" data-max="10" data-key="proprete"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>
    <div class="crit"><div>Présence/état des affiches<br/><small>sur 10 points</small></div>
      <div class="checks labeled" data-max="10" data-key="affiches"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>
    <div class="crit"><div>Accessibilité des contenants<br/><small>sur 10 points</small></div>
      <div class="checks labeled" data-max="10" data-key="accessibilite"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>
    <div class="crit"><div>Respect du tri<br/><small>sur 40 points</small></div>
      <div class="checks labeled" data-max="40" data-key="tri"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>
    <div class="crit"><div>État des bennes de déchets<br/><small>sur 20 points</small></div>
      <div class="checks labeled" data-max="20" data-key="bennes"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>
    <div class="crit"><div>Départ des contenants<br/><small>sur 10 points</small></div>
      <div class="checks labeled" data-max="10" data-key="depart"><div class="letters"><span>S</span><span>A</span><span>M</span><span>I</span></div>
        <div class="boxes"><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/><input type="checkbox"/></div>
      </div></div>

    <!-- Galerie multi-photos -->
    <div class="field">
      <label>Écarts constatés (photos + commentaires)</label>
      <div class="row">
        <input type="file" id="photosInput" accept="image/*" capture="environment" multiple />
        <button class="btn secondary small" id="btnAddFromCam" type="button">Prendre une photo</button>
      </div>
      <div id="photosList" class="photos-grid muted">Aucune photo pour le moment</div>
      <div class="muted">Astuce : sélection multiple possible. Chaque photo possède son propre commentaire.</div>
    </div>

    <div class="row">
      <button class="btn" id="btnSaveZone">Enregistrer la fiche</button>
      <button class="btn secondary" id="btnClearZone">Réinitialiser</button>
    </div>
    <div class="muted">Coche 1 case par critère (100/75/50/25 %). Aucune cochée = 0. “Gravité” divise la note enregistrée par 5.</div>
  </div>
</section>
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true"></div>

<!-- MODAL STATS -->
<section class="modal stats" id="statsModal" aria-hidden="true">
  <header>
    <div style="font-weight:700">Taux de conformité par groupe</div>
    <div class="row">
      <span class="chip" id="statsChip">—</span>
      <button class="btn secondary small" id="btnCloseStats">Fermer</button>
    </div>
  </header>
  <div class="content grid">
    <div id="barsContainer" class="grid"></div>
    <div class="table">
      <header><div>Zone</div><div>Groupe</div><div>Nb photos</div><div>Commentaire</div><div>Score</div></header>
      <div id="zoneRows"></div>
    </div>
  </div>
</section>
<div class="modal-backdrop" id="statsBackdrop" aria-hidden="true"></div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" aria-hidden="true">
  <div class="toolbar">
    <button class="btn secondary small" id="lbZoomOut">–</button>
    <button class="btn secondary small" id="lbZoomReset">100%</button>
    <button class="btn secondary small" id="lbZoomIn">+</button>
  </div>
  <button class="btn secondary small close" id="lbClose">Fermer</button>
  <img id="lightboxImg" src="" alt="Agrandissement">
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
"use strict";

/* ===== Helpers ===== */
const $ = (q)=>document.querySelector(q);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
function fileToDataURL(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); }); }
function parseLocaleDate(s){ const d = new Date(s); return Number.isNaN(d.getTime()) ? Date.now() : d.getTime(); }

/* ===== Panneau ===== */
const panel = $('#panel');
$('#btnTogglePanel').addEventListener('click', ()=> panel.classList.toggle('open'));
$('#btnClosePanel').addEventListener('click', ()=> panel.classList.remove('open'));

/* ===== Données ===== */
const coords = {
  "MR5 Atelier2":{x:243,y:684},"MR15":{x:301,y:606},"MR13":{x:312,y:577},
  "MR6 Enduis et Peinture":{x:400,y:600},"MR13 Atelier 4":{x:392,y:648},"MR1":{x:392,y:704},
  "MR13 Atelier5":{x:461,y:728},"MR5 Atelier23":{x:369,y:763},"MR3 Voie 35D":{x:552,y:554},
  "MR6 KD Lavage":{x:536,y:505},"MR4 Atelier6":{x:854,y:419},"BUMR":{x:790,y:460},
  "MR2 - MR13":{x:680,y:665},"MR2 Porte":{x:665,y:711},"MR2 Fenêtre":{x:670,y:747},
  "MR2 Etabli":{x:738,y:747},"MR3":{x:774,y:659},"MR2 HUB":{x:852,y:685},
  "MR7 Peinture + ponçage":{x:953,y:607},"MR7 préparation":{x:934,y:749},"CABOUT":{x:1034,y:688},
  "PRM11":{x:1028,y:745},"PRM4":{x:1189,y:747},"PRM5 Compresseur":{x:1258,y:692},
  "PRM10 Rechauffeur":{x:1325,y:678},"PRM1 MVT":{x:1321,y:740},"PRM3":{x:1336,y:532},
  "PRM2":{x:1322,y:428},"PRM7 Atelier12":{x:1280,y:345},"PRM6 CAPA":{x:1203,y:331},
  "PRM6 Blow WC":{x:1496,y:730},"PRM6 Pièces sanitaire":{x:1474,y:665},"PRM6 Lavage":{x:1468,y:608},
  "SC2 Amont CT10":{x:1452,y:490},"SC2 Magasin":{x:1596,y:499},"SC2 Réception":{x:1527,y:420},
  "SC Kitting":{x:1534,y:355},"MR8 Grenailleuse":{x:1504,y:249},"Bogies":{x:1670,y:287},
  "MABOR":{x:1804,y:282},"PRM8":{x:1732,y:733},
  "Z1":{x:1875,y:584},"Z2":{x:1814,y:755},"Z3":{x:1768,y:366},"Z4":{x:1634,y:379},
  "Z5":{x:1602,y:182},"Z6":{x:1416,y:382},"Z7":{x:1529,y:492},"Z8":{x:1415,y:448},
  "Z9":{x:1419,y:617},"Z10":{x:1590,y:676},"Z11":{x:1415,y:734},"Z12":{x:1205,y:204},
  "Z13":{x:1285,y:412},"Z14":{x:1111,y:371},"Z15":{x:1200,y:603},"Z16":{x:1026,y:620},
  "Z17":{x:1122,y:644},"Z18":{x:1048,y:544},"Z19":{x:921,y:329},"Z20":{x:834,y:378},
  "Z21":{x:710,y:415},"Z22":{x:704,y:600},"Z23":{x:865,y:608},"Z24":{x:735,y:714},
  "Z25":{x:965,y:728},"Z26":{x:785,y:791},"Z27":{x:602,y:788},"Z28":{x:478,y:433},
  "Z29":{x:442,y:511},"Z30":{x:317,y:547},"Z31":{x:212,y:600},"Z32":{x:1156,y:738},
  "Z33":{x:292,y:689},"Z34":{x:511,y:685},"Z35":{x:1534,y:329},"Z36":{x:1119,y:598},
  "Bureau Administratif":{x:1524,y:152}
};
const dechetsParZone = {
  Z1:["Bois","Carton","Bac noir","Plastique"],
  Z2:["Ferreux","Cuivre","Non ferreux","Caoutchouc","Bois","Carton","Condenseur","Geobox Déchets dangereux","Bac noir","Bac jaune","Aérosols","DEEE"],
  Z3:["Carton","Bois","Réhausses KC","Geobox Déchets dangereux","Ferreux","Caoutchouc","Aérosols","Pélican","Huile usagées"],
  Z4:["Carton","Bois","Geobox Déchets dangereux","Bac noir","Polystyrène","Réhausses KC"],
  Z5:["Bac noir","Bac jaune","Carton","Cartouche d'encre"],
  Z6:["Bac noir","Bac jaune"], Z7:["Bac noir","Plastique"],
  Z8:["Bois","Carton","Ferreux","Polystyrène","Plastique","Bac jaune","Bac noir"],
  Z9:["Carton","Bois","Bac noir","Réhausses KC"],
  Z10:["Aérosols","Bac noir","Non ferreux","Carton"],
  Z11:["Carton","Bois","Polystyrène","Plastique","DEEE","Non ferreux","Réhausses KC","Aérosols","Pélican","Bac jaune","Ferreux","Caoutchouc","Geobox Déchets dangereux"],
  Z12:["Bac noir","Bac jaune"],
  Z13:["Piles et Accumulateur","Geobox Déchets dangereux","Aérosols","Ferreux","Cuivre","Non ferreux","DEEE","Caoutchouc","Huile usagées"],
  Z14:["Aérosols","Ferreux","Non ferreux","Bac noir","Bac jaune","Geobox Déchets dangereux","Carton","Bois","Réhausses KC"],
  Z15:["DEEE","Carton","Non ferreux","Ferreux","Plastique","Polystyrène","Bac noir"],
  Z16:["Piles et Accumulateur","Cartouche d'encre","Vêtements usagées","Bac noir","Aérosols","DEEE","Carton","Bac jaune"],
  Z17:["DEEE","Aérosols","Bac noir","Geobox Déchets dangereux","Huile usagées"],
  Z18:["Bois","Carton","Ferreux","Non ferreux","Bac noir","Bac jaune","Verre","Déchets non dangereux"],
  Z19:["Bac noir"],
  Z20:["Ferreux","Non ferreux","Geobox Déchets dangereux","Bois","Carton","Plastique","Bac plomb"],
  Z21:["Verre","Bois","Carton","Ferreux","Non ferreux","Geobox Déchets dangereux","Plastique","Polystyrène","DEEE","Pélican","Bac jaune","GRV Huiles","GRV Cool Elf"],
  Z22:["Geobox Déchets dangereux","Fût peinture"],
  Z23:["Ampoules","Néons","Aérosols","Bac noir","Bac jaune"],
  Z24:["Caoutchouc","Pélican","Verre"],
  Z25:["Geobox Déchets dangereux"], Z26:["Carton","Bois"],
  Z27:["Bois","Carton","Ferreux","Non ferreux","Geobox Déchets dangereux","Plastique","Polystyrène","Aérosols"],
  Z28:["Ferreux","Bac noir","Fût filtres","Huile usagées"],
  Z29:["Geobox Déchets dangereux"],
  Z30:["Geobox Déchets dangereux","Pélican","Bac jaune","Carton","Bois","DEEE","Non ferreux","Ferreux","Aérosols","Amiante"],
  Z31:["Bac noir","Bac jaune","Amiante"],
  Z32:["Geobox Déchets dangereux","Non ferreux","Ferreux"],
  Z33:["Amiante"], Z34:["Bac noir","Bac jaune"], Z35:["Bac noir","Bac jaune","Plastique","Carton"]
};
const GROUPS = {
  BA:["Z5","Z12","Z19"],
  MR:["Z3","Z14","Z17","Z18","Z20","Z21","Z22","Z23","Z24","Z25","Z26","Z27","Z28","Z29","Z30","Z31","Z33","Z34"],
  MTN:["Z16"],
  SC:["Z1","Z4","Z6","Z7","Z8","Z35"],
  PRM:["Z2","Z9","Z10","Z11","Z13","Z15","Z32"],
};
const ZONES_ALL = Array.from({length:35},(_,i)=>`Z${i+1}`);

/* ===== UI : selects ===== */
let choicesZone, choicesDechet;
function initChoices(){
  choicesZone   = new Choices($('#zoneSelect'),   {searchEnabled:true,shouldSort:false,itemSelectText:'',placeholderValue:'Rechercher un emplacement…'});
  choicesDechet = new Choices($('#dechetSelect'), {searchEnabled:true,shouldSort:true, itemSelectText:'',placeholderValue:'Rechercher un déchet…'});

  Object.keys(coords).filter(k=>!k.startsWith('Z')).forEach(k=>{
    choicesZone.setChoices([{value:k,label:k}], 'value','label', false);
  });
  const allTypes=[...new Set(Object.values(dechetsParZone).flat())].sort();
  allTypes.forEach(t=>choicesDechet.setChoices([{value:t,label:t}], 'value','label', false));

  $('#zoneSelect').addEventListener('change', e=>{
    updateInfoPanel(e.target.value);
    const types=dechetsParZone[e.target.value]||allTypes;
    choicesDechet.clearChoices();
    types.forEach(t=>choicesDechet.setChoices([{value:t,label:t}], 'value','label', false));
  });
}
function updateInfoPanel(zone){
  const ul=$('#dechetList'); ul.innerHTML='';
  (dechetsParZone[zone]||[]).sort().forEach(t=>{const li=document.createElement('li');li.textContent=t;ul.appendChild(li);});
  if(!(dechetsParZone[zone]||[]).length) ul.innerHTML='<li>Aucun déchet</li>';
}

/* ===== Carte / zoom-pan ===== */
const mapContainer=$('#mapContainer');
const mapImg=$('#mapImage');
const canvas=$('#overlay'); const ctx=canvas.getContext('2d');
let base={s:1,ox:0,oy:0,iw:1,ih:1}; let view={z:1, panX:0, panY:0};
let dragging=false, lx=0, ly=0;

function computeFit(){
  const r=mapContainer.getBoundingClientRect();
  canvas.width=r.width; canvas.height=r.height;
  base.iw=mapImg.naturalWidth||1; base.ih=mapImg.naturalHeight||1;
  const s=Math.min(r.width/base.iw, r.height/base.ih);
  base.s=s; base.ox=(r.width-base.iw*s)/2; base.oy=(r.height-base.ih*s)/2;
}
function applyLayout(){
  const w=base.iw*base.s*view.z, h=base.ih*base.s*view.z;
  mapImg.style.width=w+'px'; mapImg.style.height=h+'px';
  mapImg.style.left=(base.ox+view.panX)+'px'; mapImg.style.top=(base.oy+view.panY)+'px';
  $('#kpiZoom').textContent=Math.round(view.z*100)+'%';
}
function fitAndCenter(){ computeFit(); view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); }
new ResizeObserver(()=>{ fitAndCenter(); }).observe(mapContainer);
mapImg.addEventListener('load', ()=>{ fitAndCenter(); });
if (mapImg.complete) setTimeout(fitAndCenter,0);

function imgToScreen(pt){ return {x:(base.ox+view.panX)+pt.x*(base.s*view.z), y:(base.oy+view.panY)+pt.y*(base.s*view.z)}; }
function screenToImg(x,y){ return {x:(x-base.ox-view.panX)/(base.s*view.z), y:(y-base.oy-view.panY)/(base.s*view.z)}; }

function setZoom(z,cx,cy){
  const MIN=1, MAX=4;
  z=Math.max(MIN,Math.min(MAX,z));
  if(typeof cx==='number' && typeof cy==='number'){
    const before=screenToImg(cx,cy);
    view.z=z; applyLayout();
    const after=imgToScreen(before);
    view.panX += (cx - after.x);
    view.panY += (cy - after.y);
  } else { view.z=z; }
  applyLayout(); drawAll();
}
$('#zPlus').onclick  = ()=> setZoom(view.z+0.12, canvas.width/2, canvas.height/2);
$('#zMinus').onclick = ()=> setZoom(view.z-0.12, canvas.width/2, canvas.height/2);
$('#zReset').onclick = ()=> { view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); };
$('#btnFit').onclick = ()=> fitAndCenter();

mapContainer.addEventListener('pointerdown', e=>{ dragging=true; lx=e.clientX; ly=e.clientY; mapContainer.setPointerCapture(e.pointerId); });
mapContainer.addEventListener('pointermove', e=>{ if(!dragging) return; view.panX += e.clientX-lx; view.panY += e.clientY-ly; lx=e.clientX; ly=e.clientY; applyLayout(); drawAll(); });
mapContainer.addEventListener('pointerup', ()=> dragging=false);
mapContainer.addEventListener('pointercancel', ()=> dragging=false);
mapContainer.addEventListener('wheel', e=>{
  e.preventDefault();
  const r=mapContainer.getBoundingClientRect();
  setZoom(view.z+(e.deltaY>0?-0.12:0.12), e.clientX-r.left, e.clientY-r.top);
},{passive:false});

/* ===== Dessin + état ===== */
let route=null, hotspots=[], userPos=null; let headingDegRaw=null, headingSource='unknown'; let compassOffsetDeg=parseFloat(localStorage.getItem('compassOffsetDeg')||'0');
const zonePoints=Object.keys(coords).filter(k=>/^Z\d+$/i.test(k)).map(z=>({zone:z, x:coords[z].x, y:coords[z].y, r:12}));
const STORE_KEY='zoneReports.prm6.z9z10.v2xlsximg.idb';

/* === MIGRATION TICP->PRM6 key === */
(function(){
  try{
    const OLD='zoneReports.v3'; const NEW=STORE_KEY;
    const FLAG='__migr_ticp2prm6__';
    if(!localStorage.getItem(FLAG)){
      let merged={};
      try{ const old=JSON.parse(localStorage.getItem(OLD)||'{}')||{}; merged={...merged,...old}; }catch{}
      try{ const cur=JSON.parse(localStorage.getItem(NEW)||'{}')||{}; merged={...merged,...cur}; }catch{}
      localStorage.setItem(NEW, JSON.stringify(merged));
      localStorage.setItem(FLAG, '1');
    }
  }catch{}
})();


let reports={}; try{ reports=JSON.parse(localStorage.getItem(STORE_KEY)||'{}')||{} }catch{ reports={} }
const isZoneDone=z=>!!reports[z];

function drawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(route){
    const p0=imgToScreen(route.from), p1=imgToScreen(route.to);
    ctx.save(); ctx.setLineDash([12,6]); ctx.lineWidth=4; ctx.strokeStyle='rgba(37,99,235,.85)';
    ctx.beginPath(); ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.stroke(); ctx.restore();
    const rad=8+4*Math.abs(Math.sin(performance.now()/350));
    ctx.beginPath(); ctx.arc(p0.x,p0.y,rad,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle='#ef4444'; ctx.stroke();
    ctx.beginPath(); ctx.arc(p1.x,p1.y,rad,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle='#10b981'; ctx.stroke();
  }
  for(const zp of zonePoints){
    const p=imgToScreen(zp);
    ctx.beginPath(); ctx.arc(p.x,p.y,zp.r,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle=isZoneDone(zp.zone)?'#10b981':'#ef4444'; ctx.stroke();
    ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fillStyle=isZoneDone(zp.zone)?'rgba(16,185,129,.6)':'rgba(239,68,68,.5)'; ctx.fill();
  }
  for(const h of hotspots){ const p=imgToScreen(h); ctx.beginPath(); ctx.arc(p.x,p.y,(h.r||12),0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle='#ef4444'; ctx.stroke(); }
  if(userPos){
    const p=imgToScreen(userPos);
    ctx.beginPath(); ctx.arc(p.x,p.y,10,0,Math.PI*2); ctx.fillStyle='rgba(16,185,129,.9)'; ctx.fill();
    ctx.strokeStyle='#065f46'; ctx.stroke();
    const angRad=normalizedHeadingRad(); if(angRad!=null){
      const ang=angRad - Math.PI/2, len=80;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(ang);
      ctx.beginPath(); ctx.moveTo(0,-16); ctx.lineTo(-7,-6); ctx.lineTo(7,-6); ctx.closePath();
      ctx.fillStyle='#2563eb'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,len,-Math.PI/6,Math.PI/6); ctx.closePath();
      ctx.fillStyle='rgba(37,99,235,.16)'; ctx.fill();
      ctx.restore();
    }
  }
}
(function loop(){ requestAnimationFrame(loop); drawAll(); })();

/* ===== Tracer / Effacer / Pick ===== */
$('#btnOK').addEventListener('click', ()=>{
  const dep=$('#zoneSelect').value; const waste=$('#dechetSelect').value.toLowerCase().trim();
  let origin=null; if(dep && coords[dep]) origin=coords[dep]; if(!origin && userPos) origin=userPos;
  if(!origin){ toast('Sélectionnez un emplacement ou activez le GPS.'); return; }

  let best=null,dmin=Infinity;
  for(const z in dechetsParZone){
    if(dechetsParZone[z].some(x=>x.toLowerCase()===waste)){
      const d=Math.hypot(coords[z].x-origin.x, coords[z].y-origin.y);
      if(d<dmin){ dmin=d; best=z; }
    }
  }
  if(!best){ toast('Aucune zone pour ce déchet.'); return; }

  updateInfoPanel(best);
  route={ from:{...origin}, to:{x:coords[best].x, y:coords[best].y} };
  hotspots=[{ x:coords[best].x, y:coords[best].y, r:12, zone:best }];
});
$('#btnClear').addEventListener('click', ()=>{ route=null; hotspots=[]; drawAll(); });

let pick=false;
$('#btnPick').addEventListener('click', ()=>{ pick=!pick; toast(pick?'Cliquez sur le plan pour choisir l’emplacement':'Sélection par clic désactivée'); });
mapContainer.addEventListener('click', e=>{
  const r=mapContainer.getBoundingClientRect();
  const sx=e.clientX-r.left, sy=e.clientY-r.top;
  if(pick){
    const imgPt=screenToImg(sx,sy);
    let best=null,dmin=Infinity;
    Object.keys(coords).forEach(name=>{
      if(!/^Z\d+$/i.test(name)){
        const c=coords[name], d=Math.hypot(c.x-imgPt.x, c.y-imgPt.y);
        if(d<dmin){ dmin=d; best=name; }
      }
    });
    if(best){ choicesZone.setChoiceByValue(best); $('#zoneSelect').dispatchEvent(new Event('change')); pick=false; return; }
  }
  let nearest=null,dmin=Infinity;
  for(const zp of zonePoints){ const p=imgToScreen(zp); const d=Math.hypot(sx-p.x, sy-p.y); if(d<dmin){ dmin=d; nearest=zp.zone; } }
  if(nearest && dmin<=20){ openZoneForm(nearest); }
});

/* ===== GPS + Boussole ===== */
function screenOrientationAngle(){
  const a=(screen.orientation&&typeof screen.orientation.angle==='number')?screen.orientation.angle:(typeof window.orientation==='number'?window.orientation:0);
  return ((a%360)+360)%360;
}
function normalizedHeadingDeg(){
  if (headingDegRaw==null) return null;
  let h;
  if (headingSource==='ios'){ h=headingDegRaw; }
  else { h=360-headingDegRaw; h+=screenOrientationAngle(); }
  h+=compassOffsetDeg; return ((h%360)+360)%360;
}
function normalizedHeadingRad(){ const d=normalizedHeadingDeg(); return d==null?null:d*Math.PI/180; }
function handleOrient(e){
  if (typeof e.webkitCompassHeading==='number'){ headingDegRaw=e.webkitCompassHeading; headingSource='ios'; }
  else if (typeof e.alpha==='number'){ headingDegRaw=e.alpha; headingSource='alpha'; }
  const h=normalizedHeadingDeg();
  $('#chipCompass').textContent = h==null ? 'Boussole: off' : `Boussole: on (${Math.round(compassOffsetDeg)}°)`;
  $('#kpiHead').textContent = h==null ? '—' : (Math.round(h)+'°');
}
function calibrateCompassToZero(){
  const h=normalizedHeadingDeg() ?? headingDegRaw;
  if(h==null){ toast('Boussole indisponible, bougez le téléphone puis réessayez.'); return; }
  compassOffsetDeg = ((-h)%360+360)%360; localStorage.setItem('compassOffsetDeg', String(compassOffsetDeg));
  toast(`Calibration ok (${Math.round(compassOffsetDeg)}°)`);
}
function nudgeOffset(d){ compassOffsetDeg=((compassOffsetDeg+d)%360+360)%360; localStorage.setItem('compassOffsetDeg', String(compassOffsetDeg)); }
$('#btnCalibrate').addEventListener('click', calibrateCompassToZero);
$('#btnNudgeMinus').addEventListener('click', ()=>{ nudgeOffset(-5); toast('Offset -5°'); });
$('#btnNudgePlus').addEventListener('click', ()=>{ nudgeOffset(+5); toast('Offset +5°'); });

let watchId=null, compassEnabled=false;
$('#btnGPS').addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast('GPS non disponible'); return; }
  if(watchId==null){
    const calibration = [
      {lat: 45.193611, lon: 0.705167, x: coords["Z12"].x,   y: coords["Z12"].y},
      {lat: 45.192694, lon: 0.706000, x: coords["Z5"].x,    y: coords["Z5"].y},
      {lat: 45.192194, lon: 0.706083, x: coords["MABOR"].x, y: coords["MABOR"].y}
    ];
    function gpsToPixel(lat, lon) {
      const [P0, P1, P2] = calibration;
      const lat0 = P0.lat, lon0 = P0.lon;
      const avgLat = (P0.lat + P1.lat + P2.lat)/3 * Math.PI/180;
      const kx = 111320 * Math.cos(avgLat), ky = 111320;
      function barycentric(px, py, x0, y0, x1, y1, x2, y2) {
        const detT = (y1 - y2)*(x0 - x2) + (x2 - x1)*(y0 - y2);
        const u = ((y1 - y2)*(px - x2) + (x2 - x1)*(py - y2)) / detT;
        const v = ((y2 - y0)*(px - x2) + (x0 - x2)*(py - y2)) / detT;
        const w = 1 - u - v;
        return [u, v, w];
      }
      const px = (lon - lon0) * kx;
      const py = (lat - lat0) * ky;
      const x1 = (P1.lon - lon0) * kx, y1 = (P1.lat - lat0) * ky;
      const x2 = (P2.lon - lon0) * kx, y2 = (P2.lat - lat0) * ky;
      const [u, v, w] = barycentric(px, py, 0, 0, x1, y1, x2, y2);
      return { x: u*P0.x + v*P1.x + w*P2.x, y: u*P0.y + v*P1.y + w*P2.y };
    }
    watchId = navigator.geolocation.watchPosition(pos=>{
      const p=gpsToPixel(pos.coords.latitude, pos.coords.longitude);
      userPos=p; $('#kpiPos').textContent=`${Math.round(p.x)}, ${Math.round(p.y)}`;
      $('#chipGps').textContent='GPS: on';
    }, err=>toast('Erreur GPS : '+err.message), {enableHighAccuracy:true});
  }
  if(!compassEnabled){
    if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(res=>{
        if(res==='granted'){ window.addEventListener('deviceorientation', handleOrient, true); compassEnabled=true; }
        else { $('#chipCompass').textContent='Boussole: refusée'; }
      }).catch(()=> toast('Boussole indisponible'));
    }else{
      window.addEventListener('deviceorientation', handleOrient, true); compassEnabled=true;
    }
    if (screen.orientation && typeof screen.orientation.addEventListener==='function'){
      screen.orientation.addEventListener('change', handleOrient);
    } else { window.addEventListener('orientationchange', handleOrient); }
  }

  const sel=$('#zoneSelect');
  if (![...sel.options].some(o=>o.value==='Ma localisation')){
    sel.prepend(new Option('Ma localisation','Ma localisation',true,true));
  }
  if (window.matchMedia('(min-width:1025px)').matches) panel.classList.add('open');
});

/* ===== FICHE ZONE ===== */
const modal=$('#zoneModal'), backdrop=$('#modalBackdrop');
const titleEl=$('#zoneTitle'), subEl=$('#zoneSubtitle'), chipEl=$('#scoreChip');
const checksContainers=()=>[...document.querySelectorAll('.checks')];
let currentZone=null, gravite=false;

let photosLocal=[]; // [{dataUrl, comment, ts}]
const photosInput = document.getElementById('photosInput');
const photosList  = document.getElementById('photosList');
const btnAddFromCam = document.getElementById('btnAddFromCam');

async function addFilesToGallery(fileList){
  const files = Array.from(fileList||[]);
  for(const f of files){
    try{ const dataUrl = await fileToDataURL(f); photosLocal.push({ dataUrl, comment:'', ts: Date.now() }); }catch(_){}
  }
  renderPhotos();
}
function renderPhotos(){
  if(!photosLocal.length){
    photosList.classList.add('muted');
    photosList.innerHTML = 'Aucune photo pour le moment';
    return;
  }
  photosList.classList.remove('muted');
  photosList.innerHTML = '';
  photosLocal.forEach((p,idx)=>{
    const card = document.createElement('div');
    card.className = 'photo-card';
    const safeSrc = (typeof p.dataUrl==='string' && p.dataUrl.startsWith('data:')) ? p.dataUrl : '';
    card.innerHTML = `
      <img src="${safeSrc}" alt="Écart ${idx+1}">
      <textarea placeholder="Commentaire de la photo...">${p.comment||''}</textarea>
      <div class="row photo-actions">
        <span class="muted">#${idx+1} • ${new Date(p.ts).toLocaleString()}</span>
        <div class="row">
          <button type="button" class="btn secondary small" data-act="replace" data-idx="${idx}">Remplacer</button>
          <button type="button" class="btn secondary small" data-act="delete" data-idx="${idx}">Supprimer</button>
        </div>
      </div>
    `;
    card.querySelector('textarea').addEventListener('input', ()=>{ photosLocal[idx].comment = card.querySelector('textarea').value; });
    card.querySelector('img').addEventListener('click',()=> { if(safeSrc) openLightboxFromSrc(safeSrc); });
    photosList.appendChild(card);
  });
}
photosInput.addEventListener('change', (e)=> addFilesToGallery(e.target.files));
btnAddFromCam.addEventListener('click', ()=>{ photosInput.setAttribute('capture','environment'); photosInput.click(); });

photosList.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const idx = parseInt(btn.dataset.idx,10); if(Number.isNaN(idx)) return;
  if(btn.dataset.act === 'delete'){
    photosLocal.splice(idx,1); renderPhotos();
  }else if(btn.dataset.act === 'replace'){
    const tmp = document.createElement('input');
    tmp.type='file'; tmp.accept='image/*'; tmp.capture='environment';
    tmp.addEventListener('change', async ()=>{
      if(tmp.files && tmp.files[0]){
        const dataUrl = await fileToDataURL(tmp.files[0]);
        photosLocal[idx].dataUrl = dataUrl;
        photosLocal[idx].ts = Date.now();
        renderPhotos();
      }
    });
    tmp.click();
  }
});

function openZoneForm(zone){
  currentZone=zone; gravite=false; $('#btnGravite').classList.remove('on');
  titleEl.textContent=`Fiche • ${zone}`;
  subEl.textContent=(dechetsParZone[zone]||[]).length?`Déchets: ${dechetsParZone[zone].join(', ')}`:'Aucun type déclaré';
  checksContainers().forEach(c=>[...c.querySelectorAll('input')].forEach(cb=>cb.checked=false));
  photosInput.value=''; photosLocal=[]; renderPhotos();

  const saved=reports[zone];
  if(saved){
    const idxByKey=saved.scores||{};
    checksContainers().forEach(c=>{ const key=c.dataset.key, idx=idxByKey[key]; if(Number.isInteger(idx)&&idx>=0&&idx<=3){ c.querySelectorAll('input')[idx].checked=true; }});
    if(saved.gravite){ gravite=true; $('#btnGravite').classList.add('on'); }
    if(saved.photos && Array.isArray(saved.photos)){
      photosLocal = saved.photos.map(p=>({ dataUrl:p.dataUrl, comment:p.comment||'', ts:p.ts||Date.now() }));
      renderPhotos();
    }
  }
  updateTotalChip();
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); backdrop.style.display='block';
}
function closeZoneForm(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); backdrop.style.display='none'; }
$('#btnCloseModal').addEventListener('click', closeZoneForm);
backdrop.addEventListener('click', closeZoneForm);

document.getElementById('btnGravite').addEventListener('click', ()=>{ gravite=!gravite; document.getElementById('btnGravite').classList.toggle('on', gravite); updateTotalChip(); });
document.addEventListener('change', e=>{
  const cb=e.target;
  if(cb.matches('.checks input[type="checkbox"]')){
    const group=cb.closest('.checks'); const boxes=[...group.querySelectorAll('input')];
    if(cb.checked){ boxes.forEach(b=>{ if(b!==cb) b.checked=false; }); }
    updateTotalChip();
  }
});
function fractionForIndex(idx){ return [1,0.75,0.5,0.25][idx] ?? 0; }
function computeRawTotalAndDetail(){ let total=0, detail={};
  checksContainers().forEach(c=>{ const max=parseFloat(c.dataset.max||'0'); const key=c.dataset.key; const idx=[...c.querySelectorAll('input')].findIndex(x=>x.checked); detail[key]=idx; if(idx>=0) total+=max*fractionForIndex(idx); });
  return {raw:total, detail};
}
function adjustedScore(raw){ return gravite ? raw/5 : raw; }
function updateTotalChip(){ const {raw}=computeRawTotalAndDetail(); const adj=adjustedScore(raw); chipEl.textContent=`Total : ${Math.round(adj)} / 100`+(gravite?' (gravité)':''); }

$('#btnSaveZone').addEventListener('click', ()=>{
  if(!currentZone) return;
  const {raw,detail}=computeRawTotalAndDetail();
  const totalAdj=Math.round(adjustedScore(raw));
  
const existing = reports[currentZone]||{ photos:[] };
reports[currentZone] = { ...existing, detail, gravite, score: totalAdj, updatedAt: Date.now() };
const photosWithKeys = [];
let idx=0;
(async ()=>{
  for(const p of photosLocal){
    const key = p.key || `${currentZone}:${Date.now()}:${idx++}`;
    await idbSet('photos', { key, zone: currentZone, ts: p.ts||Date.now(), dataUrl: p.dataUrl, comment: p.comment||'' });
    photosWithKeys.push({ key });
  }
  // Index keys (PRM6)
  reports[currentZone].photos = photosWithKeys;
  // Compat TICP (ancien): duplique aussi
  reports[currentZone].scores = detail;
  reports[currentZone].total  = totalAdj;
  // Optionnel: copie inline pour affichage immédiat
  reports[currentZone].photosInline = photosLocal.slice(0);
  localStorage.setItem(STORE_KEY, JSON.stringify(reports));
})();

  toast(`Fiche ${currentZone} enregistrée (${totalAdj} / 100${gravite?' • gravité':''})`);
  closeZoneForm(); drawAll();
});
$('#btnClearZone').addEventListener('click', ()=>{ checksContainers().forEach(c=>[...c.querySelectorAll('input')].forEach(cb=>cb.checked=false)); gravite=false; document.getElementById('btnGravite').classList.remove('on'); photosInput.value=''; photosLocal=[]; renderPhotos(); updateTotalChip(); });

/* ===== Stats/Graphiques ===== */
const statsModal=$('#statsModal'), statsBackdrop=$('#statsBackdrop');
$('#btnOpenStats').addEventListener('click', openStats);
$('#btnCloseStats').addEventListener('click', closeStats);
statsBackdrop.addEventListener('click', closeStats);

function groupOf(zone){
  for(const [g,arr] of Object.entries(GROUPS)){ if(arr.includes(zone)) return g; }
  return '—';
}
function openStats(){ renderStats(); statsModal.classList.add('open'); statsModal.setAttribute('aria-hidden','false'); statsBackdrop.style.display='block'; }
function closeStats(){ statsModal.classList.remove('open'); statsModal.setAttribute('aria-hidden','true'); statsBackdrop.style.display='none'; }

function renderStats(){
  const bars=$('#barsContainer'); bars.innerHTML=''; const rows=$('#zoneRows'); rows.innerHTML='';

  const perGroup={};
  Object.entries(GROUPS).forEach(([g,zs])=>{
    const done=zs.map(z=>reports[z]?.total ?? null).filter(v=>v!==null);
    const avg=done.length?(done.reduce((a,b)=>a+b,0)/done.length):0;
    perGroup[g]={avg, count:done.length, totalZones:zs.length};
  });

  const allScores=Object.values(reports).map(r=>r.total);
  const globalAvg=allScores.length?(allScores.reduce((a,b)=>a+b,0)/allScores.length):0;
  const globalSum=allScores.reduce((a,b)=>a+b,0);
  $('#statsChip').textContent=`Global : ${Math.round(globalAvg)}% • Total ${globalSum} pts • ${allScores.length} zone(s) notée(s)`;

  ZONES_ALL.forEach(z=>{
    const g=groupOf(z);
    const r=reports[z];
    const div=document.createElement('div'); div.className='row';
    const c1=document.createElement('div'); c1.textContent=z;
    const c2=document.createElement('div'); c2.textContent=g;
    const c3=document.createElement('div'); c3.textContent=(r && r.photos)? r.photos.length : 0;
    const c4=document.createElement('div'); c4.textContent=r?.photos?.[0]?.comment ? r.photos[0].comment : '';
    const c5=document.createElement('div'); c5.style.textAlign='right'; c5.textContent=(r?`${r.total} / 100${r.gravite?'*':''}`:'—');
    div.appendChild(c1); div.appendChild(c2); div.appendChild(c3); div.appendChild(c4); div.appendChild(c5);
    rows.appendChild(div);
  });
}

/* ===== Réinitialiser ===== */
document.getElementById('btnResetAll').addEventListener('click', ()=>{
  const confirmMsg = 'Confirmer la réinitialisation ?\nToutes les fiches enregistrées seront supprimées.';
  if(!confirm(confirmMsg)) return;
  localStorage.removeItem(STORE_KEY);
  reports = {};
  toast('Tournée réinitialisée.');
  drawAll();
  if(statsModal.classList.contains('open')) renderStats();
});

/* ===== Export XLS (HTML) ===== */
document.getElementById('btnExportXls').addEventListener('click', exportXls);
function idxToPct(idx){ return (idx===0?1:idx===1?0.75:idx===2?0.5:idx===3?0.25:0); }
function scoreFromIdx(max, idx){ return (idx>=0) ? Math.round(max * idxToPct(idx)) : 0; }
function buildExport(){
  const criteriaMax = {proprete:10, affiches:10, accessibilite:10, tri:40, bennes:20, depart:10};
  const rows=[];  const photosRows=[];
  ZONES_ALL.forEach(z=>{
    const r=reports[z]; if(!r) return;
    const s=r.scores||{};
    rows.push({
      Zone:z,
      Groupe:groupOf(z),
      Propreté:scoreFromIdx(criteriaMax.proprete, s.proprete ?? -1),
      Affiches:scoreFromIdx(criteriaMax.affiches, s.affiches ?? -1),
      Accessibilité:scoreFromIdx(criteriaMax.accessibilite, s.accessibilite ?? -1),
      Tri:scoreFromIdx(criteriaMax.tri, s.tri ?? -1),
      Bennes:scoreFromIdx(criteriaMax.bennes, s.bennes ?? -1),
      Départ:scoreFromIdx(criteriaMax.depart, s.depart ?? -1),
      Gravité:r.gravite?'Oui':'Non',
      Total:r.total,
      NbPhotos:(r.photos && Array.isArray(r.photos)) ? r.photos.length : 0,
      Date: r.savedAt ? new Date(r.savedAt).toLocaleString() : ''
    });
    (r.photos||[]).forEach((p,i)=>{
      photosRows.push({
        Zone:z,
        Groupe:groupOf(z),
        Index:i+1,
        Date: new Date(p.ts||r.savedAt||Date.now()).toLocaleString(),
        Commentaire:p.comment||'',
        DataUrl:p.dataUrl
      });
    });
  });
  return {rows, photosRows};
}
function exportXls(){
  const {rows, photosRows} = buildExport();
  if(!rows.length){ toast('Aucune fiche à exporter.'); return; }
  const totalAll = rows.reduce((a,b)=>a+(b.Total||0),0);
  const avgAll   = Math.round(totalAll / rows.length);
  const perGroup = {};
  rows.forEach(r=>{ perGroup[r.Groupe] ??= {sum:0,count:0}; perGroup[r.Groupe].sum+= (r.Total||0); perGroup[r.Groupe].count++; });

  const headers1 = ['Zone','Groupe','Propreté','Affiches','Accessibilité','Tri','Bennes','Départ','Gravité','Total','Nb photos','Date'];
  const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  let html = '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>';
  html += '<h2>Résumé de tournée</h2>';
  html += `<p><b>Total toutes les zones notées :</b> ${totalAll} points — <b>Moyenne globale :</b> ${avgAll}% — <b>Zones notées :</b> ${rows.length} / 35</p>`;

  html += '<table border="1"><thead><tr>'+headers1.map(h=>`<th>${esc(h)}</th>`).join('')+'</tr></thead><tbody>';
  rows.forEach(r=>{ html += '<tr>'+headers1.map(h=>`<td>${esc(r[h]??'')}</td>`).join('')+'</tr>'; });
  html += '</tbody></table>';

  html += '<br/><h3>Moyennes par groupe</h3>';
  html += '<table border="1"><thead><tr><th>Groupe</th><th>Zones notées</th><th>Moyenne</th><th>Somme</th></tr></thead><tbody>';
  Object.entries(perGroup).forEach(([g,st])=>{
    const avg = st.count? Math.round(st.sum/st.count) : 0;
    html += `<tr><td>${esc(g)}</td><td>${st.count}</td><td>${avg}%</td><td>${st.sum}</td></tr>`;
  });
  html += '</tbody></table>';

  if(photosRows.length){
    html += '<br/><h3>Écarts (photos)</h3>';
    html += '<table border="1"><thead><tr><th>Zone</th><th>Groupe</th><th>#</th><th>Date</th><th>Commentaire</th><th>Image</th></tr></thead><tbody>';
    photosRows.forEach(p=>{
      const safe = (typeof p.DataUrl==='string' && p.DataUrl.startsWith('data:')) ? p.DataUrl : '';
      html += `<tr><td>${esc(p.Zone)}</td><td>${esc(p.Groupe)}</td><td>${p.Index}</td><td>${esc(p.Date)}</td><td>${esc(p.Commentaire)}</td><td>${safe?`<img src="${safe}" alt="photo" width="220">`:''}</td></tr>`;
    });
    html += '</tbody></table>';
  }

  html += '</body></html>';

  const blob = new Blob([html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const dateStr = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.href = url; a.download = `tournee-dechets_${dateStr}.xls`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export XLS généré.');
}

/* ===== Lightbox ===== */
const lightbox = document.getElementById('lightbox');
const lbImg    = document.getElementById('lightboxImg');
const lbClose  = document.getElementById('lbClose');
const lbIn     = document.getElementById('lbZoomIn');
const lbOut    = document.getElementById('lbZoomOut');
const lbReset  = document.getElementById('lbZoomReset');

let lbScale = 1, lbX = 0, lbY = 0, lbDrag = false, lbLX = 0, lbLY = 0;

function applyLbTransform(){ lbImg.style.transform = `translate(${lbX}px, ${lbY}px) scale(${lbScale})`; }
function openLightboxFromSrc(src){
  if(!src || typeof src!=='string' || !src.startsWith('data:')){ toast('Image indisponible'); return; }
  lbImg.src = src; lbScale = 1; lbX = 0; lbY = 0; applyLbTransform();
  lightbox.style.display = 'flex';
  lightbox.setAttribute('aria-hidden','false');
}
function closeLightbox(){ lightbox.style.display = 'none'; lightbox.setAttribute('aria-hidden','true'); lbImg.src = ''; }
lbClose.addEventListener('click', closeLightbox);
lightbox.addEventListener('click', (e)=>{ if(e.target === lightbox) closeLightbox(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && lightbox.style.display === 'flex') closeLightbox(); });
lbIn.addEventListener('click', ()=>{ lbScale = Math.min(6, lbScale + 0.25); applyLbTransform(); });
lbOut.addEventListener('click', ()=>{ lbScale = Math.max(1, lbScale - 0.25); applyLbTransform(); });
lbReset.addEventListener('click', ()=>{ lbScale = 1; lbX = 0; lbY = 0; applyLbTransform(); });

lbImg.addEventListener('pointerdown', (e)=>{ lbDrag = true; lbLX = e.clientX; lbLY = e.clientY; lbImg.setPointerCapture(e.pointerId); });
lbImg.addEventListener('pointermove', (e)=>{ if(!lbDrag) return; lbX += e.clientX - lbLX; lbY += e.clientY - lbLY; lbLX = e.clientX; lbLY = e.clientY; applyLbTransform(); });
lbImg.addEventListener('pointerup',   ()=>{ lbDrag = false; });
lbImg.addEventListener('pointercancel',()=>{ lbDrag = false; });

lbImg.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.1 : 0.1;
  lbScale = Math.max(1, Math.min(6, lbScale + delta));
  applyLbTransform();
}, {passive:false});

/* ============================================================
   ========  IMPORT / FUSION DE TOURNÉES (.xlsx / .xls) =======
   ============================================================ */

document.getElementById('fileImport').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length){ toast('Aucun fichier sélectionné'); return; }
  let importedZones = 0, importedPhotos = 0, overwritten = 0, skippedNoPhoto = 0;

  for(const f of files){
    try{
      if (/\.(xlsx)$/i.test(f.name)){
        const {zones, photos} = await importFromXlsx(f);
        const r = mergeIntoReports(zones, photos);
        importedZones += r.zonesAdded; importedPhotos += r.photosAdded; overwritten += r.overwritten; skippedNoPhoto += r.skipped;
      } else if (/\.(xls)$/i.test(f.name)){
        const text = await f.text();
        const {zones, photos} = importFromXlsHtml(text);
        const r = mergeIntoReports(zones, photos);
        importedZones += r.zonesAdded; importedPhotos += r.photosAdded; overwritten += r.overwritten; skippedNoPhoto += r.skipped;
      } else {
        toast(`Format non pris en charge: ${f.name}`);
      }
    }catch(err){
      console.error('Import error', err);
      toast(`Erreur import ${f.name}`);
    }
  }

  localStorage.setItem(STORE_KEY, JSON.stringify(reports));
  drawAll(); if(statsModal.classList.contains('open')) renderStats();

  toast(`Fusion OK • Zones+${importedZones} (écrasées ${overwritten}) • Photos+${importedPhotos}${skippedNoPhoto?` • Sans photo:${skippedNoPhoto}`:''}`);
  e.target.value=''; // reset input
});

/* ---- IMPORT XLSX (corrigé : accepte Image/DataUrl/Photo) ---- */
async function importFromXlsx(file){
  const ab = await file.arrayBuffer();
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(ab);

  const zones = new Map();   // zone -> { total, gravite, savedAt }
  const photos = new Map();  // zone -> [{dataUrl, comment, ts}, ...]

  // Feuille "Résumé"
  const wsSum = wb.getWorksheet('Résumé') || wb.getWorksheet('Resume');
  if(wsSum){
    const header = {};
    wsSum.getRow(1).eachCell((c,idx)=>{ header[(c.value||'').toString().trim()] = idx; });
    wsSum.eachRow((row, rIdx)=>{
      if(rIdx===1) return;
      const get = (name)=> row.getCell(header[name]||0).value;
      const z = String(get('Zone')||'').trim();
      if(!/^Z\d+$/i.test(z)) return;
      const total = Number(get('Total')||0);
      const grav  = String(get('Gravité')||get('Gravite')||'').toLowerCase().startsWith('o');
      const dateStr = row.getCell(header['Date']||0).text || get('Date') || '';
      const savedAt = (new Date(dateStr)).getTime() || Date.now();
      zones.set(z, { total, gravite:grav, savedAt });
    });
  }

  // Feuille "Photos"
  const wsPh = wb.getWorksheet('Photos');
  if(wsPh){
    const H = {};
    wsPh.getRow(1).eachCell((c,idx)=>{ H[(c.value||'').toString().trim()] = idx; });

    const imageKey =
      ('Image'   in H) ? 'Image'   :
      ('DataUrl' in H) ? 'DataUrl' :
      ('Photo'   in H) ? 'Photo'   : null;

    wsPh.eachRow((row, rIdx)=>{
      if(rIdx===1) return;
      const getTxt = (name)=> {
        const cell = row.getCell(H[name]||0);
        return (cell && (cell.text||cell.value||'')).toString();
      };

      const z = (getTxt('Zone')||'').trim();
      if(!/^Z\d+$/i.test(z)) return;

      const comment = getTxt('Commentaire')||'';
      const dateStr = getTxt('Date')||'';
      const ts = (new Date(dateStr)).getTime() || Date.now();

      let dataUrl = imageKey ? (getTxt(imageKey)||'').trim() : '';
      if (!dataUrl && H['Photo']!=null) dataUrl = getTxt('Photo').trim();

      if(dataUrl && /^data:/i.test(dataUrl)){
        if(!photos.has(z)) photos.set(z,[]);
        photos.get(z).push({ dataUrl, comment, ts });
      }
    });
  }

  return {zones, photos};
}

/* ---- IMPORT XLS HTML ---- */
function importFromXlsHtml(htmlText){
  const zones = new Map();  const photos = new Map();
  const doc = new DOMParser().parseFromString(htmlText, 'text/html');

  const tables = Array.from(doc.querySelectorAll('table'));
  for(const table of tables){
    const headers = Array.from(table.querySelectorAll('thead tr th')).map(th=>th.textContent.trim());
    if(headers.length && headers.includes('Zone') && headers.includes('Total')){
      const idxZone = headers.indexOf('Zone');
      const idxTot  = headers.indexOf('Total');
      const idxGra  = headers.indexOf('Gravité');
      const idxDate = headers.indexOf('Date');
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const tds = Array.from(tr.children).map(td=>td.textContent.trim());
        const z = (tds[idxZone]||'').trim();
        if(!/^Z\d+$/i.test(z)) return;
        const total = parseInt(tds[idxTot]||'0',10)||0;
        const gravite = (tds[idxGra]||'').toLowerCase().startsWith('o');
        const savedAt = parseLocaleDate(tds[idxDate]||'');
        zones.set(z, { total, gravite, savedAt });
      });
    }
  }

  for(const table of tables){
    const headers = Array.from(table.querySelectorAll('thead tr th')).map(th=>th.textContent.trim());
    if(headers.length && headers.includes('Image') && headers.includes('Zone')){
      const idxZone = headers.indexOf('Zone');
      const idxCom  = headers.indexOf('Commentaire');
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const tds = Array.from(tr.children);
        const z = (tds[idxZone]?.textContent||'').trim();
        if(!/^Z\d+$/i.test(z)) return;
        const comment = (tds[idxCom]?.textContent||'').trim();
        const img = tds[tds.length-1]?.querySelector('img');
        const src = img?.getAttribute('src')||'';
        if(src && src.startsWith('data:')){
          const ts = Date.now();
          if(!photos.has(z)) photos.set(z,[]);
          photos.get(z).push({dataUrl:src, comment, ts});
        }
      });
    }
  }
  return {zones, photos};
}

/* ---- Fusion dans reports ---- */
function mergeIntoReports(zonesMap, photosMap){
  let zonesAdded=0, photosAdded=0, overwritten=0, skipped=0;
  const dedup = new Set();
  for(const r of Object.values(reports)){ (r.photos||[]).forEach(p=>{ if(p?.dataUrl) dedup.add(p.dataUrl); }); }

  zonesMap.forEach((zData, zName)=>{
    const incoming = {
      scores: reports[zName]?.scores||null,
      total: zData.total||0,
      gravite: !!zData.gravite,
      savedAt: zData.savedAt || Date.now(),
      photos: (reports[zName]?.photos||[]).slice(0)
    };

    const existed = !!reports[zName];
    const shouldReplace = !existed || (incoming.savedAt > (reports[zName].savedAt||0)) || (incoming.total !== (reports[zName].total||-1));

    if(shouldReplace){
      reports[zName] = incoming;
      if(existed) overwritten++; else zonesAdded++;
    }

    const ph = photosMap.get(zName)||[];
    if(ph.length===0){ skipped++; }
    ph.forEach(p=>{
      if(p?.dataUrl && !dedup.has(p.dataUrl)){
        reports[zName].photos.push({ dataUrl:p.dataUrl, comment:p.comment||'', ts:p.ts||Date.now() });
        dedup.add(p.dataUrl);
        photosAdded++;
      }
    });
  });

  return {zonesAdded, photosAdded, overwritten, skipped};
}

/* ===== Init ===== */
function init(){ initChoices(); fitAndCenter(); }
document.addEventListener('DOMContentLoaded', init);
</script>

<script>
/* === Sélection unique par critère (PRM6-like) + alignement géré par CSS === */
document.addEventListener('change', function(e){
  const cb = e.target;
  if(!(cb instanceof HTMLInputElement) || cb.type !== 'checkbox') return;
  const group = cb.closest('.checks.labeled');
  if(!group) return;
  const boxes = group.querySelectorAll('.boxes input[type="checkbox"]');
  if(cb.checked){
    boxes.forEach(b => { if(b !== cb) b.checked = false; });
  }
});
</script>
  <script src="shared-store.js"></script>
</body>
</html>

<script>

/* === Sync inter-onglets PRM6 key === */
window.addEventListener('storage', (e)=>{
  if(e.key===STORE_KEY){
    try{ reports = JSON.parse(e.newValue||'{}')||{} }catch{ reports = {} }
    try{ if(typeof drawAll==='function') drawAll(); }catch{}
    try{ if(typeof renderList==='function') renderList(); }catch{}
    try{ if(typeof renderStats==='function') renderStats(); }catch{}
  }
});

</script>


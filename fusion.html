
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil de Fusion des Tournées Déchets</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="0%" r="100%"><stop offset="0%" stop-color="white" stop-opacity="0.1"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>');
            pointer-events: none;
        }

        .header h1 {
            margin: 0;
            font-size: 3rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            margin: 15px 0 0 0;
            opacity: 0.95;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s;
        }

        .drop-zone:hover::before {
            left: 100%;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.2);
        }

        .drop-zone.processing {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fff8e1 0%, #fef9e7 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .drop-zone .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-success:hover {
            box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e5e7eb;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 500;
        }

        .journal {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 12px;
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .journal::-webkit-scrollbar {
            width: 6px;
        }

        .journal::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .journal::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px;
        }

        .journal-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .journal-entry:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .journal-entry:last-child {
            border-bottom: none;
        }

        .journal-entry .timestamp {
            color: #6b7280;
            font-size: 0.9rem;
            min-width: 85px;
            font-weight: 500;
        }

        .journal-entry .message {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }

        .journal-entry .status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .journal-entry.error .status {
            background: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .journal-entry.warning .status {
            background: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .btn-remove {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .btn-remove:hover {
            background: #fee2e2;
            opacity: 1;
            transform: scale(1.1);
        }

        .file-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .file-size {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗂️ Outil de Fusion des Tournées Déchets</h1>
            <p>Importez et fusionnez vos fichiers d'équipes pour consolider les données de tournées</p>
        </div>

        <div class="main-content">
            <!-- Section Import -->
            <div class="section">
                <h2>📁 Import des Fichiers</h2>
                <div class="drop-zone" id="dropZone">
                    <div class="icon">📤</div>
                    <h3>Glissez-déposez vos fichiers .xlsx ici</h3>
                    <p>ou cliquez pour sélectionner plusieurs fichiers</p>
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Sélectionner les fichiers
                    </button>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx,.xls">
                
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="file-list" id="fileList"></div>
                
                <div class="add-more-section" id="addMoreSection" style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 15px;">
                        ➕ Ajouter d'autres fichiers
                    </button>
                </div>
            </div>

            <!-- Section Statistiques -->
            <div class="section">
                <h2>📊 Statistiques</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statFiles">0</div>
                        <div class="stat-label">Fichiers importés</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statZones">0</div>
                        <div class="stat-label">Zones consolidées</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statPhotos">0</div>
                        <div class="stat-label">Photos avec données</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statPhotosEmpty">0</div>
                        <div class="stat-label">Photos sans données</div>
                    </div>
                </div>
            </div>

            <!-- Section Journal -->
            <div class="section">
                <h2>📋 Journal des Opérations</h2>
                <div class="journal" id="journal">
                    <div class="journal-entry">
                        <div class="timestamp">--:--</div>
                        <div class="status"></div>
                        <div class="message">En attente de fichiers...</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn" id="fusionBtn" onclick="processFusion()" disabled>
                    🔄 Lancer la Fusion
                </button>
                <button class="btn btn-success" id="openTicpBtn" onclick="openTICP()" disabled>
                    🚀 Ouvrir l'outil TICP
                </button>
                <button class="btn" id="diagnosticBtn" onclick="runDiagnostic()" disabled style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    🔍 Diagnostic Images
                </button>
                <button class="btn" onclick="clearData()">
                    🗑️ Effacer les données
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let consolidatedData = {};
        let stats = {
            files: 0,
            zones: 0,
            photosWithData: 0,
            photosEmpty: 0
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupDropZone();
            setupFileInput();
            checkExistingData();
        });

        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            dropZone.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }

        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (newFiles.length === 0) {
                addJournalEntry('Aucun fichier Excel valide sélectionné', 'error');
                return;
            }

            // Ajouter les nouveaux fichiers à la liste existante (éviter les doublons)
            newFiles.forEach(newFile => {
                const exists = selectedFiles.some(existingFile => 
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                );
                if (!exists) {
                    selectedFiles.push(newFile);
                }
            });

            displayFileList();
            document.getElementById('fusionBtn').disabled = false;
            document.getElementById('diagnosticBtn').disabled = false;
            
            if (newFiles.length === selectedFiles.length) {
                addJournalEntry(`${selectedFiles.length} fichier(s) sélectionné(s)`, 'success');
            } else {
                addJournalEntry(`${newFiles.length} nouveau(x) fichier(s) ajouté(s) - Total: ${selectedFiles.length}`, 'success');
            }
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            const addMoreSection = document.getElementById('addMoreSection');
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <button class="btn-remove" onclick="removeFile(${index})" title="Supprimer ce fichier">❌</button>
                `;
                fileList.appendChild(fileItem);
            });

            // Afficher le bouton "Ajouter d'autres fichiers" si on a déjà des fichiers
            addMoreSection.style.display = selectedFiles.length > 0 ? 'block' : 'none';
        }

        function removeFile(index) {
            const fileName = selectedFiles[index].name;
            selectedFiles.splice(index, 1);
            displayFileList();
            
            if (selectedFiles.length === 0) {
                document.getElementById('fusionBtn').disabled = true;
                document.getElementById('diagnosticBtn').disabled = true;
                document.getElementById('addMoreSection').style.display = 'none';
            }
            
            addJournalEntry(`Fichier supprimé: ${fileName}`, 'warning');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processFusion() {
            if (selectedFiles.length === 0) return;

            document.getElementById('fusionBtn').disabled = true;
            document.getElementById('dropZone').classList.add('processing');
            showProgress(true);

            consolidatedData = {};
            stats = { files: 0, zones: 0, photosWithData: 0, photosEmpty: 0 };

            addJournalEntry('Début de la fusion des fichiers...', 'success');

            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    updateProgress((i / selectedFiles.length) * 100);
                    
                    addJournalEntry(`Traitement de ${file.name}...`);
                    const result = await processFile(file);
                    if (result.photosFound > 0) {
                        addJournalEntry(`${result.photosFound} photo(s) trouvée(s) dans ${file.name}`);
                    }
                    stats.files++;
                }

                updateProgress(100);
                
                // Vérifier la taille des données avant sauvegarde
                const dataString = JSON.stringify(consolidatedData);
                const dataSizeMB = (dataString.length / (1024 * 1024)).toFixed(2);
                addJournalEntry(`📊 Taille des données: ${dataSizeMB} MB`);
                
                // Optimiser les données avant sauvegarde pour éviter le dépassement de quota
                const optimizedData = optimizeDataForStorage(consolidatedData);
                const optimizedString = JSON.stringify(optimizedData);
                const optimizedSizeMB = (optimizedString.length / (1024 * 1024)).toFixed(2);
                
                if (optimizedSizeMB !== dataSizeMB) {
                    addJournalEntry(`🗜️ Taille après optimisation: ${optimizedSizeMB} MB`);
                }
                
                try {
                    // Nettoyer d'abord toutes les anciennes données pour libérer l'espace
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('zoneReports') || key.includes('zone') || key.includes('report'))) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                        addJournalEntry(`🧹 Nettoyage: ${key} supprimé`);
                    });
                    
                    // Maintenant essayer de sauvegarder
                    localStorage.setItem('zoneReports.v3', optimizedString);
                    addJournalEntry('💾 Données sauvegardées avec succès');
                } catch (storageError) {
                    console.error('Erreur de stockage:', storageError);
                    addJournalEntry(`❌ Erreur de sauvegarde: ${storageError.message}`, 'error');
                    
                    // Essayer de vider complètement le localStorage et réessayer
                    try {
                        addJournalEntry('🧹 Nettoyage complet du localStorage...');
                        localStorage.clear();
                        localStorage.setItem('zoneReports.v3', optimizedString);
                        addJournalEntry('💾 Données sauvegardées après nettoyage complet');
                    } catch (secondError) {
                        addJournalEntry('⚠️ Impossible de sauvegarder, données en mémoire uniquement', 'warning');
                        addJournalEntry(`💡 Taille: ${optimizedSizeMB} MB - Fermez d'autres onglets ou redémarrez le navigateur`, 'warning');
                    }
                }
                
                stats.zones = Object.keys(consolidatedData).length;
                updateStats();
                
                addJournalEntry(`Fusion terminée: ${stats.zones} zones consolidées`, 'success');
                document.getElementById('openTicpBtn').disabled = false;

            } catch (error) {
                addJournalEntry(`Erreur lors de la fusion: ${error.message}`, 'error');
                console.error('Erreur de fusion:', error);
            } finally {
                document.getElementById('fusionBtn').disabled = false;
                document.getElementById('dropZone').classList.remove('processing');
                showProgress(false);
            }
        }

        async function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        let photosFound = 0;
                        
                        // Traitement de la feuille Résumé
                        if (workbook.SheetNames.includes('Résumé')) {
                            processResumeSheet(workbook.Sheets['Résumé']);
                        }
                        
                        // Traitement de la feuille Photos
                        if (workbook.SheetNames.includes('Photos')) {
                            photosFound = processPhotosSheet(workbook.Sheets['Photos']);
                        }
                        
                        // Debug: afficher les feuilles disponibles
                        addJournalEntry(`Feuilles trouvées: ${workbook.SheetNames.join(', ')}`);
                        
                        resolve({ photosFound });
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processResumeSheet(sheet) {
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            data.forEach((row, index) => {
                if (index === 0) return; // Skip header
                
                const zone = row[0];
                if (!zone || !zone.toString().startsWith('Z')) return;
                
                const zoneData = {
                    scores: {
                        proprete: parseInt(row[2]) || 0,
                        affiches: parseInt(row[3]) || 0,
                        accessibilite: parseInt(row[4]) || 0,
                        tri: parseInt(row[5]) || 0,
                        bennes: parseInt(row[6]) || 0,
                        depart: parseInt(row[7]) || 0
                    },
                    total: parseInt(row[8]) || 0,
                    gravite: row[9] === 'Oui' || row[9] === true,
                    savedAt: new Date().toISOString(),
                    photos: []
                };

                // Si la zone existe déjà, garder la plus récente
                if (!consolidatedData[zone] || new Date(zoneData.savedAt) > new Date(consolidatedData[zone].savedAt)) {
                    consolidatedData[zone] = zoneData;
                }
            });
        }

        function processPhotosSheet(sheet) {
            let photosFound = 0;
            
            // Traitement avec les données brutes pour récupérer les images
            const range = XLSX.utils.decode_range(sheet['!ref']);
            
            // Debug: afficher la structure de la feuille
            addJournalEntry(`📊 Analyse feuille Photos: ${range.e.r - range.s.r} lignes`);
            
            // Vérifier s'il y a des images intégrées dans le workbook
            if (sheet['!images']) {
                addJournalEntry(`🖼️ Images intégrées détectées: ${sheet['!images'].length}`);
            }
            
            // Vérifier les objets de dessin (où sont souvent stockées les images)
            if (sheet['!drawings']) {
                addJournalEntry(`🎨 Objets de dessin détectés: ${sheet['!drawings'].length}`);
            }
            
            // Vérifier les médias intégrés
            if (sheet['!media']) {
                addJournalEntry(`📷 Médias intégrés détectés: ${sheet['!media'].length}`);
            }
            
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const zoneCell = sheet[XLSX.utils.encode_cell({r: R, c: 0})];
                const commentCell = sheet[XLSX.utils.encode_cell({r: R, c: 1})];
                
                if (!zoneCell || !zoneCell.v) continue;
                
                const zone = zoneCell.v.toString();
                if (!zone.startsWith('Z')) continue;
                
                const comment = commentCell ? (commentCell.v || '') : '';
                let dataUrl = '';
                
                // Rechercher l'image dans toutes les colonnes de cette ligne
                for (let C = 0; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const cell = sheet[cellAddress];
                    
                    if (!cell) continue;
                    
                    // Vérifier toutes les propriétés de chaque cellule
                    Object.keys(cell).forEach(key => {
                        const value = cell[key];
                        if (typeof value === 'string' && value.startsWith('data:image/')) {
                            dataUrl = value;
                            addJournalEntry(`✅ Image trouvée dans ${cellAddress}.${key} pour ${zone}`);
                        }
                    });
                    
                    // Si on a trouvé une image, pas besoin de continuer
                    if (dataUrl) break;
                }
                
                // Méthode alternative: Images liées à la ligne
                if (sheet['!images'] && !dataUrl) {
                    sheet['!images'].forEach((img, idx) => {
                        if (img.from && img.from.row === R) {
                            if (img.data) {
                                dataUrl = `data:image/${img.ext || 'png'};base64,${img.data}`;
                                addJournalEntry(`✅ Image trouvée via !images pour ${zone}`);
                            }
                        }
                    });
                }
                
                // Méthode alternative: Objets de dessin liés à la ligne
                if (sheet['!drawings'] && !dataUrl) {
                    sheet['!drawings'].forEach((drawing, idx) => {
                        if (drawing.from && drawing.from.row === R) {
                            if (drawing.media && drawing.media.data) {
                                dataUrl = `data:image/${drawing.media.ext || 'png'};base64,${drawing.media.data}`;
                                addJournalEntry(`✅ Image trouvée via !drawings pour ${zone}`);
                            }
                        }
                    });
                }
                
                // Créer la zone si elle n'existe pas
                if (!consolidatedData[zone]) {
                    consolidatedData[zone] = {
                        scores: { proprete: 0, affiches: 0, accessibilite: 0, tri: 0, bennes: 0, depart: 0 },
                        total: 0,
                        gravite: false,
                        savedAt: new Date().toISOString(),
                        photos: []
                    };
                }
                
                // Ajouter la photo si elle a du contenu
                if (comment || dataUrl) {
                    const photo = {
                        comment: comment,
                        dataUrl: dataUrl,
                        ts: new Date().toISOString(),
                        zone: zone
                    };
                    
                    consolidatedData[zone].photos.push(photo);
                    photosFound++;
                    
                    if (dataUrl && dataUrl.startsWith('data:image/')) {
                        stats.photosWithData++;
                        addJournalEntry(`📸 Photo avec données ajoutée pour ${zone}`);
                    } else {
                        stats.photosEmpty++;
                        addJournalEntry(`📝 Entrée photo sans image pour ${zone}`);
                    }
                }
            }
            
            addJournalEntry(`🎯 Total photos traitées: ${photosFound}`);
            return photosFound;
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function showProgress(show) {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0);
            }
        }

        function updateStats() {
            document.getElementById('statFiles').textContent = stats.files;
            document.getElementById('statZones').textContent = stats.zones;
            document.getElementById('statPhotos').textContent = stats.photosWithData;
            document.getElementById('statPhotosEmpty').textContent = stats.photosEmpty;
        }

        function addJournalEntry(message, type = 'info') {
            const journal = document.getElementById('journal');
            const entry = document.createElement('div');
            entry.className = `journal-entry ${type}`;
            
            const now = new Date();
            const timestamp = now.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            entry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="status"></div>
                <div class="message">${message}</div>
            `;
            
            journal.appendChild(entry);
            journal.scrollTop = journal.scrollHeight;
        }

        function openTICP() {
            // Créer un lien vers Tournée.html qui ouvrira dans un nouvel onglet
            const link = document.createElement('a');
            link.href = 'Tournée.html';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.click();
            
            addJournalEntry('Ouverture de l\'outil TICP dans un nouvel onglet', 'success');
        }

        function clearData() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données consolidées ?')) {
                localStorage.removeItem('zoneReports.v3');
                consolidatedData = {};
                selectedFiles = [];
                stats = { files: 0, zones: 0, photosWithData: 0, photosEmpty: 0 };
                
                updateStats();
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('fusionBtn').disabled = true;
                document.getElementById('openTicpBtn').disabled = true;
                
                // Réinitialiser le journal
                document.getElementById('journal').innerHTML = `
                    <div class="journal-entry">
                        <div class="timestamp">--:--</div>
                        <div class="status"></div>
                        <div class="message">Données effacées. En attente de nouveaux fichiers...</div>
                    </div>
                `;
                
                addJournalEntry('Toutes les données ont été effacées', 'success');
            }
        }

        async function runDiagnostic() {
            if (selectedFiles.length === 0) return;
            
            addJournalEntry('🔍 Début du diagnostic avancé des images...', 'success');
            
            for (const file of selectedFiles) {
                addJournalEntry(`🔎 Diagnostic approfondi de ${file.name}...`);
                
                try {
                    const workbook = await readExcelFile(file);
                    
                    // Analyser la structure du workbook
                    addJournalEntry(`📋 Feuilles: ${workbook.SheetNames.join(', ')}`);
                    
                    // Analyser le workbook entier pour les images
                    const workbookKeys = Object.keys(workbook);
                    addJournalEntry(`🏗️ Propriétés workbook: ${workbookKeys.length} éléments`);
                    
                    // Chercher des propriétés liées aux images dans le workbook
                    const imageRelatedKeys = workbookKeys.filter(key => 
                        key.toLowerCase().includes('image') || 
                        key.toLowerCase().includes('media') || 
                        key.toLowerCase().includes('drawing') ||
                        key.toLowerCase().includes('picture')
                    );
                    
                    if (imageRelatedKeys.length > 0) {
                        addJournalEntry(`🖼️ Propriétés images workbook: ${imageRelatedKeys.join(', ')}`);
                        
                        imageRelatedKeys.forEach(key => {
                            const value = workbook[key];
                            if (Array.isArray(value)) {
                                addJournalEntry(`📊 ${key}: ${value.length} éléments`);
                            } else if (typeof value === 'object') {
                                addJournalEntry(`📦 ${key}: objet avec ${Object.keys(value).length} propriétés`);
                            }
                        });
                    }
                    
                    if (workbook.SheetNames.includes('Photos')) {
                        const sheet = workbook.Sheets['Photos'];
                        
                        // Analyser les propriétés de la feuille
                        const sheetKeys = Object.keys(sheet);
                        addJournalEntry(`🔧 Propriétés feuille Photos: ${sheetKeys.length} éléments`);
                        
                        // Lister toutes les propriétés spéciales
                        const specialKeys = sheetKeys.filter(key => key.startsWith('!'));
                        if (specialKeys.length > 0) {
                            addJournalEntry(`⚡ Propriétés spéciales: ${specialKeys.join(', ')}`);
                        }
                        
                        // Chercher des images dans différentes propriétés
                        let imageProperties = [];
                        sheetKeys.forEach(key => {
                            const value = sheet[key];
                            if (key.toLowerCase().includes('image') || 
                                key.toLowerCase().includes('drawing') || 
                                key.toLowerCase().includes('media') ||
                                key.toLowerCase().includes('picture')) {
                                imageProperties.push(key);
                            }
                            
                            // Vérifier si la valeur contient des données d'image
                            if (typeof value === 'string' && value.includes('data:image/')) {
                                addJournalEntry(`🎯 Image détectée dans ${key}`);
                            } else if (typeof value === 'object' && value !== null) {
                                const objStr = JSON.stringify(value);
                                if (objStr.includes('data:image/') || objStr.includes('base64')) {
                                    addJournalEntry(`🎯 Données image possibles dans ${key}`);
                                }
                            }
                        });
                        
                        if (imageProperties.length > 0) {
                            addJournalEntry(`🖼️ Propriétés images trouvées: ${imageProperties.join(', ')}`);
                        }
                        
                        // Analyser le contenu complet de la feuille pour chercher des patterns d'images
                        const sheetStr = JSON.stringify(sheet);
                        const base64Patterns = sheetStr.match(/data:image\/[^"]+/g);
                        if (base64Patterns) {
                            addJournalEntry(`📸 ${base64Patterns.length} pattern(s) d'image détecté(s) dans la feuille`);
                            base64Patterns.forEach((pattern, idx) => {
                                const preview = pattern.substring(0, 50) + '...';
                                addJournalEntry(`🔍 Pattern ${idx + 1}: ${preview}`);
                            });
                        }
                        
                        // Analyser chaque cellule en détail
                        const range = XLSX.utils.decode_range(sheet['!ref']);
                        addJournalEntry(`📐 Range de la feuille: ${range.s.r}-${range.e.r} lignes, ${range.s.c}-${range.e.c} colonnes`);
                        
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                const cell = sheet[cellAddress];
                                
                                if (cell) {
                                    const cellProps = Object.keys(cell);
                                    const hasImageData = cellProps.some(prop => {
                                        const value = cell[prop];
                                        return typeof value === 'string' && 
                                               (value.includes('data:image/') || value.includes('base64'));
                                    });
                                    
                                    if (hasImageData || cellProps.length > 3) {
                                        addJournalEntry(`📱 ${cellAddress}: [${cellProps.join(', ')}]${hasImageData ? ' 🖼️' : ''}`);
                                        
                                        cellProps.forEach(prop => {
                                            const value = cell[prop];
                                            if (typeof value === 'string') {
                                                if (value.startsWith('data:image/')) {
                                                    addJournalEntry(`✅ IMAGE TROUVÉE dans ${cellAddress}.${prop}!`);
                                                } else if (value.length > 100) {
                                                    const preview = value.substring(0, 50);
                                                    addJournalEntry(`📄 ${cellAddress}.${prop}: "${preview}..." (${value.length} chars)`);
                                                }
                                            } else if (typeof value === 'object' && value !== null) {
                                                addJournalEntry(`📦 ${cellAddress}.${prop}: objet avec ${Object.keys(value).length} propriétés`);
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    }
                    
                } catch (error) {
                    addJournalEntry(`❌ Erreur diagnostic ${file.name}: ${error.message}`, 'error');
                }
            }
            
            addJournalEntry('✅ Diagnostic avancé terminé', 'success');
        }
        
        function optimizeDataForStorage(data) {
            // Garder toutes les données intégralement, y compris les images
            const optimized = {};
            
            Object.keys(data).forEach(zone => {
                const zoneData = { ...data[zone] };
                
                // Conserver toutes les photos avec leurs images originales
                if (zoneData.photos && zoneData.photos.length > 0) {
                    zoneData.photos = zoneData.photos.map(photo => {
                        const optimizedPhoto = { ...photo };
                        
                        // Afficher la taille des images sans les modifier
                        if (optimizedPhoto.dataUrl && optimizedPhoto.dataUrl.startsWith('data:image/')) {
                            const sizeKB = Math.round(optimizedPhoto.dataUrl.length/1024);
                            addJournalEntry(`📸 Image conservée pour ${zone} (${sizeKB}KB)`);
                        }
                        
                        return optimizedPhoto;
                    });
                }
                
                optimized[zone] = zoneData;
            });
            
            return optimized;
        }



        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        function checkExistingData() {
            const existingData = localStorage.getItem('zoneReports.v3');
            if (existingData) {
                try {
                    consolidatedData = JSON.parse(existingData);
                    stats.zones = Object.keys(consolidatedData).length;
                    
                    // Compter les photos
                    Object.values(consolidatedData).forEach(zone => {
                        if (zone.photos) {
                            zone.photos.forEach(photo => {
                                if (photo.dataUrl && photo.dataUrl.startsWith('data:image/')) {
                                    stats.photosWithData++;
                                } else {
                                    stats.photosEmpty++;
                                }
                            });
                        }
                    });
                    
                    updateStats();
                    document.getElementById('openTicpBtn').disabled = false;
                    addJournalEntry(`Données existantes trouvées: ${stats.zones} zones`, 'success');
                } catch (error) {
                    addJournalEntry('Erreur lors du chargement des données existantes', 'error');
                }
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9874686680a1d2c6',t:'MTc1OTI0MjUxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

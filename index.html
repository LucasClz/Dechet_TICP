<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TICP • Localisation & Notation Déchets</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{--brand:#E6007E;--brand-700:#b80063;--bg:#f6f7fb;--panel:#fff;--text:#1f2a37;--muted:#6b7280;--line:#e5e7eb;--ok:#16a34a;--ok-200:#dcfce7}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}

  .app{display:grid;grid-template-rows:auto 1fr;height:100%}
  header.appbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
  .bar{max-width:1600px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo{width:10px;height:28px;border-radius:999px;background:var(--brand);box-shadow:0 0 0 6px rgba(230,0,126,.08)}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#eef2ff;color:#3730a3}
  .btn{appearance:none;border:none;border-radius:10px;cursor:pointer;padding:10px 14px;font-weight:600;background:var(--brand);color:#fff;box-shadow:0 8px 22px rgba(230,0,126,.22);transition:.2s}
  .btn:hover{background:var(--brand-700);transform:translateY(-1px)}
  .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:8px 10px;border-radius:8px;font-size:12px}

  /* Panneau au-dessus (mobile), tiroir (desktop) */
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:0 0 16px 16px;box-shadow:0 10px 30px rgba(2,8,23,.06);margin:0 0 12px 0}
  .panel>header{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .panel>.content{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .field{display:grid;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,.choices__inner{width:100%}

  /* Carte : image positionnée par left/top, mise à l’échelle via width/height (AUCUNE transform CSS) */
  .mapwrap{position:relative;width:100%;background:#0b1020}
  .mapimg{position:absolute;left:0;top:0;user-select:none;-webkit-user-drag:none}
  canvas#overlay{position:absolute;left:0;top:0;pointer-events:none}

  .toolbox{position:absolute;left:12px;top:12px;z-index:5;display:flex;gap:8px;flex-wrap:wrap}
  .hud{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px;z-index:5}
  .card{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:170px;color:#111827}
  .kpi{font-size:12px;color:#6b7280;display:flex;gap:6px;align-items:center}
  .kpi strong{font-size:13px;color:#111827}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999}
  .toast.show{opacity:1}

  /* Desktop : carte plein écran, panneau tiroir */
  @media (min-width:1025px){
    .mapwrap{height:calc(100vh - 64px)}
    .panel{
      position:fixed; inset:64px 0 0 auto;
      width:420px; max-width:92vw; border-radius:0;
      transform:translateX(100%); transition:transform .25s ease;
      border-left:1px solid var(--line); border-right:none; margin:0;
      z-index:40; box-shadow:-20px 0 50px rgba(2,8,23,.15);
    }
    .panel.open{ transform:translateX(0) }
    .panel .close{ display:inline-flex }
  }

  /* Mobile/Tablet : panneau en haut + carte 70vh */
  @media (max-width:1024px){
    .mapwrap{height:70vh;min-height:520px;border-radius:16px}
    .panel .close{ display:none }
  }

  /* Modal notation */
  dialog{border:none;border-radius:14px;max-width:min(820px,96vw);width:100%;padding:0;box-shadow:0 30px 80px rgba(2,6,23,.4)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .mod{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .mod-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700}
  .mod-bd{padding:14px;display:grid;gap:12px}
  .mod-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .cardX{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .cardX h4{margin:0 0 8px;font-size:13px;color:#374151}
  .checks{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .checks label{display:flex;gap:6px;align-items:center;border:1px dashed #cbd5e1;border-radius:10px;padding:8px}
  .checks input{width:16px;height:16px}
  .muted{color:var(--muted);font-size:12px}
  .preview{display:grid;place-items:center;min-height:120px;border:1px dashed #cbd5e1;border-radius:10px;overflow:hidden}
  .preview img{max-width:100%;max-height:260px;display:block}
  textarea{min-height:84px;width:100%;resize:vertical;border:1px solid var(--line);border-radius:10px;padding:10px}
  .mod-ft{display:flex;justify-content:space-between;gap:8px;padding:12px 14px;border-top:1px solid var(--line);background:#fafafa}
  .pill-ok{display:inline-flex;align-items:center;gap:6px;background:var(--ok-200);color:#065f46;border:1px solid #86efac;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="bar">
      <div class="brand"><div class="logo"></div>TICP • Localisation & Notation des déchets</div>
      <div class="row">
        <button class="btn secondary small" id="btnTogglePanel">Panneau</button>
        <button class="btn secondary small" id="btnExportCsv">Export CSV</button>
        <button class="btn secondary small" id="btnExportJson">Export JSON</button>
        <button class="btn secondary small" id="btnResetAll">Réinitialiser</button>
        <span class="chip" id="chipGps">GPS: off</span>
        <span class="chip" id="chipCompass">Boussole: off</span>
      </div>
    </div>
  </header>

  <main>
    <!-- Panneau AU-DESSUS (mobile), tiroir (desktop) -->
    <section class="panel" id="panel">
      <header>
        Navigation & Recherche
        <button class="btn secondary small close" id="btnClosePanel" style="display:none">Fermer</button>
      </header>
      <div class="content grid">
        <div class="field">
          <label>Origine</label>
          <div class="row">
            <button class="btn small" id="btnGPS">Activer GPS + Boussole</button>
            <button class="btn secondary small" id="btnPick">Choisir sur le plan</button>
            <button class="btn secondary small" id="btnCalibrate">Calibrer boussole</button>
            <button class="btn secondary small" id="btnNudgeMinus">-5°</button>
            <button class="btn secondary small" id="btnNudgePlus">+5°</button>
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="zoneSelect">Emplacement</label>
            <select id="zoneSelect" placeholder="Rechercher un emplacement"></select>
          </div>
          <div class="field">
            <label for="dechetSelect">Déchet</label>
            <select id="dechetSelect" placeholder="Rechercher un déchet"></select>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnOK">Tracer</button>
          <button class="btn secondary" id="btnClear">Effacer</button>
        </div>

        <div class="field">
          <label>Déchets dans la zone</label>
          <ul id="dechetList" style="padding-left:18px;margin:6px 0 0 0"><li>Aucune zone sélectionnée</li></ul>
        </div>
        <div class="field">
          <span class="muted">Astuce : cliquez un point vert/rouge sur la carte (proche d'une Z*) pour ouvrir la fiche de notation.</span>
        </div>
      </div>
    </section>

    <!-- Carte -->
    <section class="mapwrap" id="mapContainer">
      <img id="mapImage" class="mapimg" src="1.png" alt="Plan du site" draggable="false"/>
      <canvas id="overlay"></canvas>

      <div class="toolbox">
        <button class="btn secondary small" id="zMinus">–</button>
        <button class="btn secondary small" id="zReset">100%</button>
        <button class="btn secondary small" id="zPlus">+</button>
        <button class="btn secondary small" id="btnFit">Ajuster</button>
      </div>

      <div class="hud">
        <div class="card">
          <div class="kpi">Position <strong id="kpiPos">—</strong></div>
          <div class="kpi">Cap <strong id="kpiHead">—</strong></div>
          <div class="kpi">Zoom <strong id="kpiZoom">100%</strong></div>
          <div class="kpi">Zone <strong id="kpiZone">—</strong></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modal Notation Zone -->
<dialog id="rateModal">
  <div class="mod">
    <div class="mod-hd">
      <div>Notation – <span id="rateTitle">Zone</span> <span id="statusPill" class="pill-ok" style="display:none">Complète</span></div>
      <button class="btn secondary small" id="btnCloseRate">Fermer</button>
    </div>
    <div class="mod-bd">
      <div class="mod-grid">
        <div class="cardX">
          <h4>Propreté de la zone (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="proprete"></div>
        </div>
        <div class="cardX">
          <h4>Présence & état des affiches (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="affiches"></div>
        </div>
        <div class="cardX">
          <h4>Accessibilité des contenants (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="accessibilite"></div>
        </div>
        <div class="cardX">
          <h4>Respect du tri (sur 25)</h4>
          <div class="checks" data-weight="25" data-key="tri"></div>
        </div>
        <div class="cardX">
          <h4>État des bennes (sur 20)</h4>
          <div class="checks" data-weight="20" data-key="bennes"></div>
        </div>
        <div class="cardX">
          <h4>Départ des contenants (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="depart"></div>
        </div>
      </div>

      <div class="cardX">
        <h4>Photo & commentaire</h4>
        <div class="preview" id="photoPreview"><span class="muted">Aucune image</span></div>
        <input type="file" id="photoInput" accept="image/*"/>
        <textarea id="photoComment" placeholder="Commentaire sur la photo (ex: emplacement, anomalie, n° benne…)"></textarea>
      </div>

      <div class="cardX">
        <h4>Récapitulatif</h4>
        <div class="muted">Cochez 0–4 cases par catégorie. Chaque case vaut un quart du total de la catégorie.</div>
        <p><strong>Score :</strong> <span id="zoneScore">0</span> / <span id="zoneMax">85</span></p>
      </div>
    </div>
    <div class="mod-ft">
      <span class="muted">Données stockées dans le navigateur.</span>
      <div class="row">
        <button class="btn secondary small" id="btnDeleteZone">Effacer la zone</button>
        <button class="btn small" id="btnSaveRate">Enregistrer</button>
      </div>
    </div>
  </div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
"use strict";

/* ===== Helpers ===== */
const $ = (q)=>document.querySelector(q);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }

/* ===== Panneau (desktop tiroir) ===== */
const panel = $('#panel');
$('#btnTogglePanel').addEventListener('click', ()=> panel.classList.toggle('open'));
$('#btnClosePanel').addEventListener('click', ()=> panel.classList.remove('open'));

/* ===== Données ===== */
const coords = { /* mêmes points */
  "MR5 Atelier2":{x:243,y:684},"MR15":{x:301,y:606},"MR13":{x:312,y:577},
  "MR6 Enduis et Peinture":{x:400,y:600},"MR13 Atelier 4":{x:392,y:648},"MR1":{x:392,y:704},
  "MR13 Atelier5":{x:461,y:728},"MR5 Atelier23":{x:369,y:763},"MR3 Voie 35D":{x:552,y:554},
  "MR6 KD Lavage":{x:536,y:505},"MR4 Atelier6":{x:854,y:419},"BUMR":{x:790,y:460},
  "MR2 - MR13":{x:680,y:665},"MR2 Porte":{x:665,y:711},"MR2 Fenêtre":{x:670,y:747},
  "MR2 Etabli":{x:738,y:747},"MR3":{x:774,y:659},"MR2 HUB":{x:852,y:685},
  "MR7 Peinture + ponçage":{x:953,y:607},"MR7 préparation":{x:934,y:749},"CABOUT":{x:1034,y:688},
  "PRM11":{x:1028,y:745},"PRM4":{x:1189,y:747},"PRM5 Compresseur":{x:1258,y:692},
  "PRM10 Rechauffeur":{x:1325,y:678},"PRM1 MVT":{x:1321,y:740},"PRM3":{x:1336,y:532},
  "PRM2":{x:1322,y:428},"PRM7 Atelier12":{x:1280,y:345},"PRM6 CAPA":{x:1203,y:331},
  "PRM6 Blow WC":{x:1496,y:730},"PRM6 Pièces sanitaire":{x:1474,y:665},"PRM6 Lavage":{x:1468,y:608},
  "SC2 Amont CT10":{x:1452,y:490},"SC2 Magasin":{x:1596,y:499},"SC2 Réception":{x:1527,y:420},
  "SC Kitting":{x:1534,y:355},"MR8 Grenailleuse":{x:1504,y:249},"Bogies":{x:1670,y:287},
  "MABOR":{x:1804,y:282},"PRM8":{x:1732,y:733},
  "Z1":{x:1875,y:584},"Z2":{x:1814,y:755},"Z3":{x:1768,y:366},"Z4":{x:1634,y:379},
  "Z5":{x:1602,y:182},"Z6":{x:1416,y:382},"Z7":{x:1529,y:492},"Z8":{x:1415,y:448},
  "Z9":{x:1419,y:617},"Z10":{x:1590,y:676},"Z11":{x:1415,y:734},"Z12":{x:1205,y:204},
  "Z13":{x:1285,y:412},"Z14":{x:1111,y:371},"Z15":{x:1200,y:603},"Z16":{x:1026,y:620},
  "Z17":{x:1122,y:644},"Z18":{x:1048,y:544},"Z19":{x:921,y:329},"Z20":{x:834,y:378},
  "Z21":{x:710,y:415},"Z22":{x:704,y:600},"Z23":{x:865,y:608},"Z24":{x:735,y:714},
  "Z25":{x:965,y:728},"Z26":{x:785,y:791},"Z27":{x:602,y:788},"Z28":{x:478,y:433},
  "Z29":{x:442,y:511},"Z30":{x:317,y:547},"Z31":{x:212,y:600},"Z32":{x:1156,y:738},
  "Z33":{x:292,y:689},"Z34":{x:511,y:685},"Z35":{x:1534,y:329},"Z36":{x:1119,y:598},
  "Bureau Administratif":{x:1524,y:152}
};

const dechetsParZone = {
  Z1:["Bois","Carton","Bac noir","Plastique"],
  Z2:["Ferreux","Cuivre","Non ferreux","Caoutchouc","Bois","Carton","Condenseur","Geobox Déchets dangereux","Bac noir","Bac jaune","Aérosols","DEEE"],
  Z3:["Carton","Bois","Réhausses KC","Geobox Déchets dangereux","Ferreux","Caoutchouc","Aérosols","Pélican","Huile usagées"],
  Z4:["Carton","Bois","Geobox Déchets dangereux","Bac noir","Polystyrène","Réhausses KC"],
  Z5:["Bac noir","Bac jaune","Carton","Cartouche d'encre"],
  Z6:["Bac noir","Bac jaune"], Z7:["Bac noir","Plastique"],
  Z8:["Bois","Carton","Ferreux","Polystyrène","Plastique","Bac jaune","Bac noir"],
  Z9:["Carton","Bois","Bac noir","Réhausses KC"],
  Z10:["Aérosols","Bac noir","Non ferreux","Carton"],
  Z11:["Carton","Bois","Polystyrène","Plastique","DEEE","Non ferreux","Réhausses KC","Aérosols","Pélican","Bac jaune","Ferreux","Caoutchouc","Geobox Déchets dangereux"],
  Z12:["Bac noir","Bac jaune"],
  Z13:["Piles et Accumulateur","Geobox Déchets dangereux","Aérosols","Ferreux","Cuivre","Non ferreux","DEEE","Caoutchouc","Huile usagées"],
  Z14:["Aérosols","Ferreux","Non ferreux","Bac noir","Bac jaune","Geobox Déchets dangereux","Carton","Bois","Réhausses KC"],
  Z15:["DEEE","Carton","Non ferreux","Ferreux","Plastique","Polystyrène","Bac noir"],
  Z16:["Piles et Accumulateur","Cartouche d'encre","Vêtements usagées","Bac noir","Aérosols","DEEE","Carton","Bac jaune"],
  Z17:["DEEE","Aérosols","Bac noir","Geobox Déchets dangereux","Huile usagées"],
  Z18:["Bois","Carton","Ferreux","Non ferreux","Bac noir","Bac jaune","Verre","Déchets non dangereux"],
  Z19:["Bac noir"],
  Z20:["Ferreux","Non ferreux","Geobox Déchets dangereux","Bois","Carton","Plastique","Bac plomb"],
  Z21:["Verre","Bois","Carton","Ferreux","Non ferreux","Geobox Déchets dangereux","Plastique","Polystyrène","DEEE","Pélican","Bac jaune","GRV Huiles","GRV Cool Elf"],
  Z22:["Geobox Déchets dangereux","Fût peinture"],
  Z23:["Ampoules","Néons","Aérosols","Bac noir","Bac jaune"],
  Z24:["Caoutchouc","Pélican","Verre"],
  Z25:["Geobox Déchets dangereux"], Z26:["Carton","Bois"],
  Z27:["Bois","Carton","Ferreux","Non ferreux","Geobox Déchets dangereux","Plastique","Polystyrène","Aérosols"],
  Z28:["Ferreux","Bac noir","Fût filtres","Huile usagées"],
  Z29:["Geobox Déchets dangereux"],
  Z30:["Geobox Déchets dangereux","Pélican","Bac jaune","Carton","Bois","DEEE","Non ferreux","Ferreux","Aérosols","Amiante"],
  Z31:["Bac noir","Bac jaune","Amiante"],
  Z32:["Geobox Déchets dangereux","Non ferreux","Ferreux"],
  Z33:["Amiante"], Z34:["Bac noir","Bac jaune"], Z35:["Bac noir","Bac jaune","Plastique","Carton"]
};

/* ===== Barres et sélecteurs ===== */
let choicesZone, choicesDechet;
function initChoices(){
  choicesZone   = new Choices($('#zoneSelect'),   {searchEnabled:true,shouldSort:false,itemSelectText:'',placeholderValue:'Rechercher un emplacement…'});
  choicesDechet = new Choices($('#dechetSelect'), {searchEnabled:true,shouldSort:true, itemSelectText:'',placeholderValue:'Rechercher un déchet…'});

  Object.keys(coords).filter(k=>!k.startsWith('Z')).forEach(k=>{
    choicesZone.setChoices([{value:k,label:k}], 'value','label', false);
  });
  const allTypes=[...new Set(Object.values(dechetsParZone).flat())].sort();
  allTypes.forEach(t=>choicesDechet.setChoices([{value:t,label:t}], 'value','label', false));

  $('#zoneSelect').addEventListener('change', e=>{
    updateInfoPanel(e.target.value);
    const types=dechetsParZone[e.target.value]||allTypes;
    choicesDechet.clearChoices();
    types.forEach(t=>choicesDechet.setChoices([{value:t,label:t}], 'value','label', false));
  });
}
function updateInfoPanel(zone){
  const ul=$('#dechetList'); ul.innerHTML='';
  (dechetsParZone[zone]||[]).sort().forEach(t=>{const li=document.createElement('li');li.textContent=t;ul.appendChild(li);});
  if(!(dechetsParZone[zone]||[]).length) ul.innerHTML='<li>Aucun déchet</li>';
  $('#kpiZone').textContent = zone || '—';
}

/* ===== Carte : fit contain + zoom/pan (sans transform CSS !) ===== */
const mapContainer=$('#mapContainer');
const mapImg=$('#mapImage');
const canvas=$('#overlay'); const ctx=canvas.getContext('2d');

let base={s:1,ox:0,oy:0,iw:1,ih:1};   // image naturelle + fit
let view={z:1, panX:0, panY:0};       // zoom/pan composés
let dragging=false, lx=0, ly=0;

function computeFit(){
  const r=mapContainer.getBoundingClientRect();
  canvas.width=r.width; canvas.height=r.height;
  base.iw=mapImg.naturalWidth||1; base.ih=mapImg.naturalHeight||1;
  const s=Math.min(r.width/base.iw, r.height/base.ih); // ENTIEREMENT visible
  base.s=s; base.ox=(r.width-base.iw*s)/2; base.oy=(r.height-base.ih*s)/2;
}

function applyLayout(){
  const w = base.iw*base.s*view.z;
  const h = base.ih*base.s*view.z;
  mapImg.style.width  = w+'px';
  mapImg.style.height = h+'px';
  mapImg.style.left   = (base.ox+view.panX)+'px';
  mapImg.style.top    = (base.oy+view.panY)+'px';
  $('#kpiZoom').textContent=Math.round(view.z*100)+'%';
}

function fitAndCenter(){ computeFit(); view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); }

new ResizeObserver(()=>{ fitAndCenter(); }).observe(mapContainer);
mapImg.addEventListener('load', ()=>{ fitAndCenter(); });
if (mapImg.complete) setTimeout(fitAndCenter,0);

// Conversions image <-> écran
function imgToScreen(pt){
  return { x: (base.ox+view.panX) + pt.x*(base.s*view.z), y: (base.oy+view.panY) + pt.y*(base.s*view.z) };
}
function screenToImg(x,y){
  return { x: (x - base.ox - view.panX) / (base.s*view.z), y: (y - base.oy - view.panY) / (base.s*view.z) };
}

// Zoom centré
function setZoom(z,cx,cy){
  const MIN=0.1, MAX=4;
  z=Math.max(MIN,Math.min(MAX,z));
  if(typeof cx==='number' && typeof cy==='number'){
    const before=screenToImg(cx,cy);
    view.z=z; applyLayout();
    const after=imgToScreen(before);
    view.panX += (cx - after.x);
    view.panY += (cy - after.y);
  } else { view.z=z; }
  applyLayout(); drawAll();
}
$('#zPlus').onclick  = ()=> setZoom(view.z+0.12, canvas.width/2, canvas.height/2);
$('#zMinus').onclick = ()=> setZoom(view.z-0.12, canvas.width/2, canvas.height/2);
$('#zReset').onclick = ()=> { view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); };
$('#btnFit').onclick = ()=> fitAndCenter();

// Pan
mapContainer.addEventListener('pointerdown', e=>{ dragging=true; lx=e.clientX; ly=e.clientY; mapContainer.setPointerCapture(e.pointerId); });
mapContainer.addEventListener('pointermove', e=>{ if(!dragging) return; view.panX += e.clientX-lx; view.panY += e.clientY-ly; lx=e.clientX; ly=e.clientY; applyLayout(); drawAll(); });
mapContainer.addEventListener('pointerup', ()=> dragging=false);
mapContainer.addEventListener('pointercancel', ()=> dragging=false);

// Zoom molette
mapContainer.addEventListener('wheel', e=>{ e.preventDefault(); const rect=mapContainer.getBoundingClientRect(); setZoom(view.z+(e.deltaY>0?-0.12:0.12), e.clientX-rect.left, e.clientY-rect.top); },{passive:false});

/* ===== Notation Zones (localStorage) ===== */
const WEIGHTS = { proprete:10, affiches:10, accessibilite:10, tri:25, bennes:20, depart:10 };
const KEYS = Object.keys(WEIGHTS);
const MAX_TOTAL = Object.values(WEIGHTS).reduce((a,b)=>a+b,0);
const zoneMaxEl = document.getElementById('zoneMax'); zoneMaxEl.textContent = MAX_TOTAL;

const rateModal = document.getElementById('rateModal');
const rateTitle = document.getElementById('rateTitle');
const zoneScoreEl = document.getElementById('zoneScore');
const statusPill = document.getElementById('statusPill');
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const photoComment = document.getElementById('photoComment');
let currentZone = null;

function zoneStoreKey(z){ return `audit_zone_${z}`; }
function loadZone(z){ const raw=localStorage.getItem(zoneStoreKey(z)); return raw?JSON.parse(raw):null; }
function saveZone(z,data){ localStorage.setItem(zoneStoreKey(z), JSON.stringify(data)); }
function deleteZone(z){ localStorage.removeItem(zoneStoreKey(z)); }
function quartToScore(weight,n){ return (weight/4)*n; }
function computeScore(payload){ return KEYS.reduce((s,k)=> s + quartToScore(WEIGHTS[k], (payload[k]||[]).filter(Boolean).length), 0); }
function isComplete(payload){ return KEYS.every(k=> (payload[k]||[]).some(v=>v)); }

// Crée 4 cases par catégorie
Array.from(document.querySelectorAll('.checks')).forEach(div=>{
  const key=div.dataset.key;
  for(let i=1;i<=4;i++){
    const id=`${key}_${i}`; const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" id="${id}" data-key="${key}" data-idx="${i}"><span>${i}</span>`;
    div.appendChild(lab);
  }
});

function openRate(z){
  currentZone=z; rateTitle.textContent = z; statusPill.style.display='none';
  // reset
  document.querySelectorAll('.checks input').forEach(cb=> cb.checked=false);
  photoPreview.innerHTML='<span class="muted">Aucune image</span>';
  photoInput.value=''; photoComment.value='';
  // load
  const data=loadZone(z);
  if(data){
    KEYS.forEach(k=>{ (data[k]||[false,false,false,false]).forEach((v,idx)=>{ const cb=document.querySelector(`input[data-key="${k}"][data-idx="${idx+1}"]`); if(cb) cb.checked=!!v; }); });
    if(data.photo){ const img=document.createElement('img'); img.src=data.photo; photoPreview.innerHTML=''; photoPreview.appendChild(img); }
    photoComment.value=data.photoComment||'';
  }
  updateScoreLive();
  rateModal.showModal();
}
$('#btnCloseRate').addEventListener('click', ()=> rateModal.close());

function updateScoreLive(){
  const tmp={}; KEYS.forEach(k=> tmp[k]=Array.from(document.querySelectorAll(`input[data-key="${k}"]`)).map(cb=>cb.checked));
  const score=computeScore(tmp); zoneScoreEl.textContent = Math.round(score*100)/100;
  statusPill.style.display = isComplete(tmp)?'inline-flex':'none';
}
document.querySelectorAll('.checks').forEach(div=> div.addEventListener('change', updateScoreLive));

photoInput.addEventListener('change', ()=>{
  const f=photoInput.files?.[0]; if(!f){ photoPreview.innerHTML='<span class="muted">Aucune image</span>'; return; }
  const r=new FileReader(); r.onload=()=>{ const img=document.createElement('img'); img.src=r.result; photoPreview.innerHTML=''; photoPreview.appendChild(img); }; r.readAsDataURL(f);
});

$('#btnSaveRate').addEventListener('click', ()=>{
  if(!currentZone) return;
  const payload={ _zone:currentZone };
  KEYS.forEach(k=> payload[k]=Array.from(document.querySelectorAll(`input[data-key="${k}"]`)).map(cb=>cb.checked));
  const img=photoPreview.querySelector('img'); payload.photo = img?img.src:null; payload.photoComment = photoComment.value||'';
  payload._score = computeScore(payload); payload._complete = isComplete(payload);
  saveZone(currentZone,payload); rateModal.close(); drawAll();
});
$('#btnDeleteZone').addEventListener('click', ()=>{ if(!currentZone) return; if(confirm(`Supprimer les données pour ${currentZone} ?`)){ deleteZone(currentZone); rateModal.close(); drawAll(); }});

/* ===== Dessin ===== */
let route=null;        // {from:{x,y}, to:{x,y}} en px image
let hotspots=[];       // [{x,y,r,zone}] en px image
let userPos=null;      // {x,y} en px image
let headingDegRaw=null, headingSource='unknown';
let compassOffsetDeg = parseFloat(localStorage.getItem('compassOffsetDeg') || '0');

function drawAll(){
  const r = mapContainer.getBoundingClientRect();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Tracé itinéraire
  if(route){
    const p0=imgToScreen(route.from), p1=imgToScreen(route.to);
    ctx.save(); ctx.setLineDash([12,6]); ctx.lineWidth=4; ctx.strokeStyle='rgba(37,99,235,.85)';
    ctx.beginPath(); ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.stroke(); ctx.restore();
    const rad=8+4*Math.abs(Math.sin(performance.now()/350));
    ctx.beginPath(); ctx.arc(p0.x,p0.y,rad,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle='#ef4444'; ctx.stroke();
    ctx.beginPath(); ctx.arc(p1.x,p1.y,rad,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle='#10b981'; ctx.stroke();
  }

  // Points zones : vert si complète, rouge sinon
  const ZONES = Object.keys(coords).filter(k=>k.startsWith('Z'));
  hotspots = ZONES.map(z=> ({ x:coords[z].x, y:coords[z].y, r:14, zone:z }));
  for(const h of hotspots){
    const scr=imgToScreen(h);
    const data=loadZone(h.zone);
    const filled = data && data._complete;
    ctx.beginPath(); ctx.arc(scr.x,scr.y,h.r,0,Math.PI*2);
    ctx.lineWidth=3; ctx.strokeStyle = filled ? '#16a34a' : '#ef4444';
    ctx.fillStyle = filled ? 'rgba(22,163,74,.18)' : 'rgba(239,68,68,.12)';
    ctx.fill(); ctx.stroke();
  }

  // Position utilisateur + cône boussole
  if(userPos){
    const p=imgToScreen(userPos);
    ctx.beginPath(); ctx.arc(p.x,p.y,10,0,Math.PI*2); ctx.fillStyle='rgba(16,185,129,.9)'; ctx.fill(); ctx.strokeStyle='#065f46'; ctx.stroke();
    const angRad = normalizedHeadingRad();
    if(angRad!=null){ const ang=angRad - Math.PI/2; const len=80; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(ang);
      ctx.beginPath(); ctx.moveTo(0,-16); ctx.lineTo(-7,-6); ctx.lineTo(7,-6); ctx.closePath(); ctx.fillStyle='#2563eb'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,len,-Math.PI/6,Math.PI/6); ctx.closePath(); ctx.fillStyle='rgba(37,99,235,.16)'; ctx.fill(); ctx.restore(); }
  }
}
(function loop(){ requestAnimationFrame(loop); drawAll(); })();

/* ===== Interaction carte : ouvrir fiche quand on clique proche d'une Z* ===== */
let pick=false;
$('#btnPick').addEventListener('click', ()=>{ pick=!pick; toast(pick?'Cliquez sur le plan pour choisir l’EMPLACEMENT d’origine':'Sélection par clic désactivée'); });

mapContainer.addEventListener('click', e=>{
  const rect=mapContainer.getBoundingClientRect();
  const imgPt=screenToImg(e.clientX-rect.left, e.clientY-rect.top);
  if(pick){ // choix d'origine
    let best=null,dmin=Infinity; Object.keys(coords).forEach(name=>{ if(!name.startsWith('Z')){ const c=coords[name], d=Math.hypot(c.x-imgPt.x, c.y-imgPt.y); if(d<dmin){ dmin=d; best=name; } } });
    if(best){ choicesZone.setChoiceByValue(best); $('#zoneSelect').dispatchEvent(new Event('change')); pick=false; }
    return;
  }
  // sinon : ouverture fiche si proche d'une zone Z*
  let nearest=null, dmin=Infinity; Object.keys(coords).forEach(name=>{ if(name.startsWith('Z')){ const c=coords[name], d=Math.hypot(c.x-imgPt.x, c.y-imgPt.y); if(d<dmin){ dmin=d; nearest=name; } } });
  const threshold=28/(base.s*view.z); // rayon en px image ≈ 28 px écran
  if(nearest && dmin<=threshold){ updateInfoPanel(nearest); openRate(nearest); }
});

/* ===== Tracer / Effacer ===== */
$('#btnOK').addEventListener('click', ()=>{
  const dep=$('#zoneSelect').value; const waste=$('#dechetSelect').value.toLowerCase().trim();
  let origin=null; if(dep && coords[dep]) origin=coords[dep]; if(!origin && userPos) origin=userPos;
  if(!origin){ toast('Sélectionnez un emplacement ou activez le GPS.'); return; }
  let best=null,dmin=Infinity; for(const z in dechetsParZone){ if(dechetsParZone[z].some(x=>x.toLowerCase()===waste)){ const d=Math.hypot(coords[z].x-origin.x, coords[z].y-origin.y); if(d<dmin){ dmin=d; best=z; } } }
  if(!best){ toast('Aucune zone pour ce déchet.'); return; }
  updateInfoPanel(best); route={ from:{...origin}, to:{x:coords[best].x, y:coords[best].y} };
});
$('#btnClear').addEventListener('click', ()=>{ route=null; drawAll(); });

/* ===== GPS + Boussole ===== */
const calibration = [
  {lat: 45.193611, lon: 0.705167, x: coords["Z12"].x,   y: coords["Z12"].y},
  {lat: 45.192694, lon: 0.706000, x: coords["Z5"].x,    y: coords["Z5"].y},
  {lat: 45.192194, lon: 0.706083, x: coords["MABOR"].x, y: coords["MABOR"].y}
];
function gpsToPixel(lat, lon) {
  const [P0, P1, P2] = calibration; const lat0 = P0.lat, lon0 = P0.lon; const avgLat = (P0.lat + P1.lat + P2.lat)/3 * Math.PI/180; const kx = 111320 * Math.cos(avgLat), ky = 111320;
  function barycentric(px, py, x0, y0, x1, y1, x2, y2) { const detT = (y1 - y2)*(x0 - x2) + (x2 - x1)*(y0 - y2); const u = ((y1 - y2)*(px - x2) + (x2 - x1)*(py - y2)) / detT; const v = ((y2 - y0)*(px - x2) + (x0 - x2)*(py - y2)) / detT; const w = 1 - u - v; return [u, v, w]; }
  const px = (lon - lon0) * kx; const py = (lat - lat0) * ky; const x1 = (P1.lon - lon0) * kx, y1 = (P1.lat - lat0) * ky; const x2 = (P2.lon - lon0) * kx, y2 = (P2.lat - lat0) * ky; const [u, v, w] = barycentric(px, py, 0, 0, x1, y1, x2, y2); return { x: u*P0.x + v*P1.x + w*P2.x, y: u*P0.y + v*P1.y + w*P2.y };
}
function screenOrientationAngle(){ const a=(screen.orientation&&typeof screen.orientation.angle==='number')?screen.orientation.angle:(typeof window.orientation==='number'?window.orientation:0); return ((a%360)+360)%360; }
function normalizedHeadingDeg(){ if (headingDegRaw==null) return null; let h; if (headingSource==='ios'){ h=headingDegRaw; } else { h=360-headingDegRaw; h+=screenOrientationAngle(); } h+=compassOffsetDeg; return ((h%360)+360)%360; }
function normalizedHeadingRad(){ const d=normalizedHeadingDeg(); return d==null?null:d*Math.PI/180; }
function handleOrient(e){ if (typeof e.webkitCompassHeading==='number'){ headingDegRaw=e.webkitCompassHeading; headingSource='ios'; } else if (typeof e.alpha==='number'){ headingDegRaw=e.alpha; headingSource='alpha'; } const h=normalizedHeadingDeg(); $('#chipCompass').textContent = h==null ? 'Boussole: off' : `Boussole: on (${Math.round(compassOffsetDeg)}°)`; $('#kpiHead').textContent = h==null ? '—' : (Math.round(h)+'°'); }
function calibrateCompassToZero(){ const h=normalizedHeadingDeg() ?? headingDegRaw; if(h==null){ toast('Boussole indisponible, bougez le téléphone puis réessayez.'); return; } compassOffsetDeg = ((-h)%360+360)%360; localStorage.setItem('compassOffsetDeg', String(compassOffsetDeg)); toast(`Calibration ok (${Math.round(compassOffsetDeg)}°)`); }
function nudgeOffset(d){ compassOffsetDeg=((compassOffsetDeg+d)%360+360)%360; localStorage.setItem('compassOffsetDeg', String(compassOffsetDeg)); }
$('#btnCalibrate').addEventListener('click', calibrateCompassToZero);
$('#btnNudgeMinus').addEventListener('click', ()=>{ nudgeOffset(-5); toast('Offset -5°'); });
$('#btnNudgePlus').addEventListener('click', ()=>{ nudgeOffset(+5); toast('Offset +5°'); });

let watchId=null, compassEnabled=false;
$('#btnGPS').addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast('GPS non disponible'); return; }
  if(watchId==null){ watchId = navigator.geolocation.watchPosition(pos=>{ const p=gpsToPixel(pos.coords.latitude, pos.coords.longitude); userPos=p; $('#kpiPos').textContent=`${Math.round(p.x)}, ${Math.round(p.y)}`; $('#chipGps').textContent='GPS: on'; }, err=>toast('Erreur GPS : '+err.message), {enableHighAccuracy:true}); }
  if(!compassEnabled){ if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){ DeviceOrientationEvent.requestPermission().then(res=>{ if(res==='granted'){ window.addEventListener('deviceorientation', handleOrient, true); compassEnabled=true; } else { $('#chipCompass').textContent='Boussole: refusée'; } }).catch(()=> toast('Boussole indisponible')); }else{ window.addEventListener('deviceorientation', handleOrient, true); compassEnabled=true; }
    if (screen.orientation && typeof screen.orientation.addEventListener==='function'){ screen.orientation.addEventListener('change', handleOrient); } else { window.addEventListener('orientationchange', handleOrient); }
  }
  const sel=$('#zoneSelect'); if (![...sel.options].some(o=>o.value==='Ma localisation')){ sel.prepend(new Option('Ma localisation','Ma localisation',true,true)); }
  if (window.matchMedia('(min-width:1025px)').matches) panel.classList.add('open');
});

/* ===== Export / Reset ===== */
function allZones(){ return Object.keys(coords).filter(k=>k.startsWith('Z')); }
function exportJson(){ const out=allZones().map(z=>({zone:z,data:loadZone(z)})); download(`tournee_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(out,null,2), 'application/json'); }
function exportCsv(){ const rows=[["zone","proprete(0-4)","affiches(0-4)","accessibilite(0-4)","tri(0-4)","bennes(0-4)","depart(0-4)","score","complete","photoComment"]]; allZones().forEach(z=>{ const d=loadZone(z)||{}; const toN=k=> (d[k]||[]).filter(Boolean).length; rows.push([z,toN('proprete'),toN('affiches'),toN('accessibilite'),toN('tri'),toN('bennes'),toN('depart'), d._score||0, d._complete?1:0, (d.photoComment||'').replace(/
/g,' ') ]); }); const csv=rows.map(r=> r.map(v=> String(v).includes(',')?`"${String(v).replaceAll('"','""')}"`:v).join(',')).join('
'); download(`tournee_${new Date().toISOString().slice(0,10)}.csv`, csv, 'text/csv'); }
function download(name, data, type='application/octet-stream'){ const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }
$('#btnExportJson').addEventListener('click', exportJson);
$('#btnExportCsv').addEventListener('click', exportCsv);
$('#btnResetAll').addEventListener('click', ()=>{ if(!confirm('Tout effacer ?')) return; allZones().forEach(deleteZone); drawAll(); toast('Réinitialisé'); });

/* ===== Init ===== */
function init(){ initChoices(); fitAndCenter(); }
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Localisation Déchets – TICP</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <style>
    :root {
      --sncf-magenta: #E6007E;
      --sncf-purple:  #5C005C;
      --sncf-light:   #F5F5F5;
      --text-dark:    #333;
    }
    body { margin:0;padding:0;font-family:'Roboto',sans-serif; background:url('51ae36f2-f712-4167-af4d-7e792ec51443.png') center/cover no-repeat fixed; color:var(--text-dark); line-height:1.4; }
    .container { max-width:1400px; margin:1rem auto; padding:1rem; background:rgba(255,255,255,0.85); box-shadow:0 4px 12px rgba(0,0,0,0.15); border-radius:8px; }
    header { text-align:center; margin-bottom:1rem; }
    header h1 { font-size:2rem; color:var(--sncf-purple); margin-bottom:0.3rem; }
    header p { font-size:1rem; color:#555; }
    .search-panel { background:#fff; padding:1rem; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:1rem; }
    form { display:flex; flex-wrap:wrap; gap:1rem; align-items:center; }
    .form-group { flex:1 1 180px; display:flex; flex-direction:column; }
    .form-group label { font-weight:500; margin-bottom:0.4rem; }
    .choices__inner { min-height:2.5rem; }
    button { background:var(--sncf-magenta); color:#fff; border:none; padding:0.6rem 1.2rem; font-size:1rem; border-radius:4px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:background 0.2s ease; }
    button:hover { background:var(--sncf-purple); }
    .main-content { display:flex; gap:1rem; }
    #mapContainer { position:relative; flex:1; background:var(--sncf-light); border-radius:6px; overflow:hidden; min-height:500px; }
    #mapImage, #overlay { width:100%; display:block; }
    #overlay { position:absolute; top:0; left:0; }
    #infoPanel { width:160px; background:#fff; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:0.75rem; font-size:0.85rem; line-height:1.2; }
    #infoPanel h2 { font-size:1rem; color:var(--sncf-magenta); margin-bottom:0.5rem; }
    #dechetList { list-style:disc inside; max-height:10rem; overflow-y:auto; margin:0; padding:0; }
    #dechetList li { margin-bottom:0.25rem; }
    #zonePopup { position:absolute; width:300px; height:300px; object-fit:cover; border:3px solid var(--sncf-magenta); border-radius:6px; display:none; pointer-events:none; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
    @media (max-width:768px) {
      header h1 { font-size:1.5rem; }
      header p  { font-size:0.9rem; }
      .search-panel form { flex-direction:column; }
      .form-group { flex:1 1 100%; }
      .main-content { flex-direction:column; }
      #infoPanel { width:100%; margin-top:1rem; max-height:30vh; overflow-y:auto; }
      #mapContainer { width:100%; height:60vh; min-height:unset; }
      #mapContainer img, #mapContainer canvas { width:100%; height:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Localisation des déchets</h1>
      <p>Choisissez votre point de départ et le type de déchet pour trouver la zone la plus proche.</p>
    </header>
    <section class="search-panel">
      <form id="searchForm">
        <div class="form-group"><button type="button" id="enableClickSelect">Choisir point de départ</button></div>
        <div class="form-group"><label for="zoneSelect">Emplacement</label><select id="zoneSelect"></select></div>
        <div class="form-group"><label for="dechetSelect">Déchet</label><select id="dechetSelect"></select></div>
        <div class="form-group"><button type="button" id="activateGPS">Activer GPS</button></div>
        <div class="form-group"><button type="submit">OK</button></div>
      </form>
    </section>
    <div class="main-content">
      <section id="mapContainer">
        <img id="mapImage" src="1.png" alt="Plan du site"/>
        <canvas id="overlay"></canvas>
        <img id="zonePopup" src="" alt="Zone déchets"/>
      </section>
      <aside id="infoPanel">
        <h2>Déchets</h2>
        <ul id="dechetList"><li>Aucune zone sélectionnée</li></ul>
      </aside>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    const coords = {/* ... */};
    const dechetsParZone = {/* ... */};
    const zoneImages = {/* ... */};
    const zoneSelect   = document.getElementById('zoneSelect');
    const dechetSelect = document.getElementById('dechetSelect');
    const activateGPS  = document.getElementById('activateGPS');
    const overlay      = document.getElementById('overlay');
    const ctx          = overlay.getContext('2d');
    let userPosition  = null;
    let calibration   = [];

    // Init Choices
    const choicesZone   = new Choices(zoneSelect, {searchEnabled:true,shouldSort:false,itemSelectText:'', placeholderValue:'Rechercher une zone…'});
    const choicesDechet = new Choices(dechetSelect, {searchEnabled:true,shouldSort:true,itemSelectText:'', placeholderValue:'Rechercher un déchet…'});
    Object.keys(coords).filter(z=>!z.startsWith('Z')).forEach(z=>choicesZone.setChoices([{value:z,label:z}],'value','label',false));
    Object.values(new Set(Object.values(dechetsParZone).flat())).sort().forEach(t=>choicesDechet.setChoices([{value:t,label:t}],'value','label',false));

    function updateInfoPanel(zone){
      const list=document.getElementById('dechetList'); list.innerHTML='';
      (dechetsParZone[zone]||[]).sort().forEach(t=>{const li=document.createElement('li');li.textContent=t;list.appendChild(li);});
      if(!(dechetsParZone[zone]||[]).length) list.innerHTML='<li>Aucun déchet</li>';
    }
    zoneSelect.addEventListener('change',()=>updateInfoPanel(zoneSelect.value));

    function ajusterCanvas(){ overlay.width=overlay.clientWidth; overlay.height=overlay.clientHeight; }
    window.addEventListener('resize',ajusterCanvas); window.onload=ajusterCanvas;

    // GPS activation
    activateGPS.addEventListener('click',()=>{
      if(!navigator.geolocation) return alert('GPS non supporté');
      navigator.geolocation.watchPosition(pos=>{
        userPosition = {lat: pos.coords.latitude, lon: pos.coords.longitude};
        drawUser();
      },err=>alert('Impossible d\'obtenir la position GPS'));
    });

    function drawUser(){
      if(!userPosition || calibration.length<2) return;
      // TODO: convertir lat/lon en pixels par calibration
      const px = 0, py = 0; // calculer via calibration
      ajusterCanvas(); ctx.clearRect(0,0,overlay.width,overlay.height);
      ctx.beginPath(); ctx.arc(px,py,8,0,2*Math.PI); ctx.fillStyle='rgba(0,150,0,0.7)'; ctx.fill();
    }

    // Calibration utilitaire (à compléter) : envoyer deux paires [lat,lon] -> [x,y]
    function addCalibrationPoint(lat,lon,x,y){ calibration.push({lat,lon,x,y}); }

    // Reste du code (recherche, animation, popup…) inchangé
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tourn√©e d√©chets ‚Äì saisie par zone</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --muted:#8aa0c5; --accent:#4ade80; --danger:#ef4444; --border:#22304d; --text:#e6eefc;
    }
    html,body{height:100%;}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); display:grid; grid-template-columns: 340px 1fr; gap:16px;}
    header{grid-column:1/-1; padding:14px 18px; border-bottom:1px solid var(--border); background:#0f1730; position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:12px}
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .actions{margin-left:auto; display:flex; gap:8px}
    button, .btn{background:#1b2845; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:12px; cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .wrap{padding:12px;}
    .sidebar{background:var(--panel); border-right:1px solid var(--border); padding:14px; display:flex; flex-direction:column; gap:12px}
    .sidebar h2{font-size:14px; margin:2px 0 4px; color:var(--muted)}
    .zones{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px}
    .zone-chip{display:flex; align-items:center; justify-content:space-between; gap:6px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#0f1730}
    .zone-chip .label{font-weight:600}
    .zone-chip .score{font-size:12px; color:var(--muted)}
    .zone-chip.filled{background:rgba(74,222,128,.12); border-color:#204b2f}

    /* Carte */
    .map{padding:12px;}
    svg{width:100%; height:calc(100vh - 120px); background:#0a1120; border-top:1px solid var(--border)}
    .zone{fill:#1b2845; stroke:#2b3f6b; stroke-width:2; cursor:pointer; transition:all .2s ease}
    .zone:hover{fill:#243863}
    .zone.filled{fill:#1d4131; stroke:#28a745}
    .zone text{pointer-events:none}

    /* Modal */
    dialog{border:none; border-radius:16px; background:#0f1730; color:var(--text); padding:0; width:min(780px, 92vw); box-shadow: 0 20px 60px rgba(0,0,0,.45)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-hd{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .modal-hd h3{margin:0; font-size:16px}
    .modal-bd{padding:16px; display:grid; gap:16px}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
    .card{border:1px solid var(--border); border-radius:14px; padding:12px; background:#0b1429}
    .card h4{margin:0 0 8px; font-size:13px; color:var(--muted)}
    .checks{display:grid; grid-template-columns: repeat(4, 1fr); gap:8px}
    .checks label{display:flex; align-items:center; gap:6px; border:1px dashed #304268; padding:8px; border-radius:10px; user-select:none}
    .checks input{width:16px; height:16px}

    .media{display:grid; gap:10px}
    .media .preview{display:grid; place-items:center; border:1px dashed #304268; border-radius:12px; min-height:120px; overflow:hidden}
    .media img{max-width:100%; max-height:260px; display:block}
    .media textarea{min-height:80px; resize:vertical; width:100%; background:#0b1429; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px}

    .modal-ft{display:flex; justify-content:space-between; padding:12px 16px; border-top:1px solid var(--border)}
    .muted{color:var(--muted); font-size:12px}
    .total{font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>üßπ Tourn√©e d√©chets ‚Äì saisie par zone</h1>
    <div class="actions">
      <button id="exportJson">Exporter JSON</button>
      <button id="exportCsv">Exporter CSV</button>
      <button id="resetAll" title="Efface toutes les saisies">R√©initialiser</button>
    </div>
  </header>

  <aside class="sidebar wrap">
    <h2>Zones</h2>
    <div id="zoneList" class="zones"></div>
  </aside>

  <main class="map wrap">
    <!-- EXEMPLE de carte (remplacez par votre plan SVG si vous en avez un).
         Chaque zone doit avoir class="zone" et un id comme Z1, Z5, etc.  -->
    <svg viewBox="0 0 800 520" aria-label="Plan des zones">
      <g id="zones-group" font-family="ui-sans-serif, system-ui" font-weight="700" font-size="18" fill="#e6eefc">
        <g id="Z1" class="zone" tabindex="0">
          <rect x="40" y="40" width="160" height="120" rx="8"></rect>
          <text x="120" y="105" text-anchor="middle">Z1</text>
        </g>
        <g id="Z2" class="zone" tabindex="0">
          <rect x="240" y="40" width="200" height="120" rx="8"></rect>
          <text x="340" y="105" text-anchor="middle">Z2</text>
        </g>
        <g id="Z3" class="zone" tabindex="0">
          <rect x="480" y="40" width="260" height="120" rx="8"></rect>
          <text x="610" y="105" text-anchor="middle">Z3</text>
        </g>
        <g id="Z4" class="zone" tabindex="0">
          <rect x="40" y="200" width="260" height="140" rx="8"></rect>
          <text x="170" y="275" text-anchor="middle">Z4</text>
        </g>
        <g id="Z5" class="zone" tabindex="0">
          <rect x="340" y="200" width="180" height="140" rx="8"></rect>
          <text x="430" y="275" text-anchor="middle">Z5</text>
        </g>
        <g id="Z6" class="zone" tabindex="0">
          <rect x="560" y="200" width="180" height="140" rx="8"></rect>
          <text x="650" y="275" text-anchor="middle">Z6</text>
        </g>
        <g id="Z7" class="zone" tabindex="0">
          <rect x="40" y="370" width="320" height="120" rx="8"></rect>
          <text x="200" y="435" text-anchor="middle">Z7</text>
        </g>
        <g id="Z8" class="zone" tabindex="0">
          <rect x="380" y="370" width="360" height="120" rx="8"></rect>
          <text x="560" y="435" text-anchor="middle">Z8</text>
        </g>
      </g>
    </svg>
  </main>

  <dialog id="modal">
    <form method="dialog" id="zoneForm">
      <div class="modal-hd">
        <h3 id="modalTitle">Zone</h3>
        <button id="closeModal" class="btn" value="close">Fermer</button>
      </div>
      <div class="modal-bd">
        <div class="grid">
          <!-- Six cat√©gories, chacune en 4 cases √† cocher -->
          <div class="card">
            <h4>Propret√© de la zone (sur 10)</h4>
            <div class="checks" data-weight="10" data-key="proprete"></div>
          </div>
          <div class="card">
            <h4>Pr√©sence & √©tat des affiches (sur 10)</h4>
            <div class="checks" data-weight="10" data-key="affiches"></div>
          </div>
          <div class="card">
            <h4>Accessibilit√© des contenants (sur 10)</h4>
            <div class="checks" data-weight="10" data-key="accessibilite"></div>
          </div>
          <div class="card">
            <h4>Respect du tri (sur 25)</h4>
            <div class="checks" data-weight="25" data-key="tri"></div>
          </div>
          <div class="card">
            <h4>√âtat des bennes (sur 20)</h4>
            <div class="checks" data-weight="20" data-key="bennes"></div>
          </div>
          <div class="card">
            <h4>D√©part des contenants (sur 10)</h4>
            <div class="checks" data-weight="10" data-key="depart"></div>
          </div>
        </div>

        <div class="card media">
          <h4>Photo & commentaire</h4>
          <div class="preview" id="photoPreview"><span class="muted">Aucune image</span></div>
          <input type="file" id="photoInput" accept="image/*" />
          <textarea id="photoComment" placeholder="Commentaire sur la photo (ex: emplacement, anomalie, n¬∞ benne...)"></textarea>
        </div>

        <div class="card">
          <h4>R√©capitulatif</h4>
          <div class="muted">Cochez 0‚Äì4 cases par cat√©gorie. Chaque case vaut un quart du total de la cat√©gorie.</div>
          <p><strong>Score zone :</strong> <span id="zoneScore">0</span> / <span id="zoneMax">85</span></p>
        </div>
      </div>
      <div class="modal-ft">
        <span class="muted">Les donn√©es sont stock√©es en local (navigateur).</span>
        <div>
          <button class="btn" id="deleteZone" type="button" style="margin-right:6px; background:#2a1b1b; border-color:#512e2e">Supprimer les donn√©es de la zone</button>
          <button class="btn" id="saveBtn" value="default">Enregistrer</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // --- Utilitaires ---
    const WEIGHTS = { proprete:10, affiches:10, accessibilite:10, tri:25, bennes:20, depart:10 };
    const KEYS = Object.keys(WEIGHTS);
    const MAX_TOTAL = Object.values(WEIGHTS).reduce((a,b)=>a+b,0); // 85

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const storeKey = z => `tournee_zone_${z}`;

    function quartToScore(weight, n){
      // n = nb de cases coch√©es (0..4)
      return (weight/4) * n;
    }

    function formatScore(data){
      return KEYS.reduce((sum,k)=> sum + quartToScore(WEIGHTS[k], (data[k]||[]).filter(Boolean).length), 0);
    }

    function saveZoneData(zoneId, data){
      localStorage.setItem(storeKey(zoneId), JSON.stringify(data));
    }

    function loadZoneData(zoneId){
      const raw = localStorage.getItem(storeKey(zoneId));
      return raw ? JSON.parse(raw) : null;
    }

    function deleteZoneData(zoneId){
      localStorage.removeItem(storeKey(zoneId));
    }

    function listAllZones(){
      return $$('#zones-group > g.zone').map(g=>g.id);
    }

    function refreshZoneStyles(){
      listAllZones().forEach(id=>{
        const g = document.getElementById(id);
        const data = loadZoneData(id);
        const filled = data && data._complete;
        g.classList.toggle('filled', !!filled);
        // Sidebar chips
        const chip = document.querySelector(`[data-chip="${id}"]`);
        if(chip){
          chip.classList.toggle('filled', !!filled);
          const score = data ? formatScore(data) : 0;
          chip.querySelector('.score').textContent = `${score} / ${MAX_TOTAL}`;
        }
      });
    }

    function buildSidebar(){
      const list = $('#zoneList'); list.innerHTML = '';
      listAllZones().forEach(id=>{
        const data = loadZoneData(id);
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'zone-chip';
        item.setAttribute('data-chip', id);
        item.innerHTML = `<span class="label">${id}</span><span class="score">${data?formatScore(data):0} / ${MAX_TOTAL}</span>`;
        item.addEventListener('click', ()=> openModalForZone(id));
        list.appendChild(item);
      });
      refreshZoneStyles();
    }

    // --- Modal & formulaire ---
    const modal = $('#modal');
    const zoneForm = $('#zoneForm');
    const photoInput = $('#photoInput');
    const photoPreview = $('#photoPreview');
    const photoComment = $('#photoComment');
    const zoneScoreEl = $('#zoneScore');
    const zoneMaxEl = $('#zoneMax');
    zoneMaxEl.textContent = MAX_TOTAL;

    // Cr√©e 4 cases par cat√©gorie
    $$('.checks').forEach(div=>{
      const key = div.dataset.key; const weight = Number(div.dataset.weight);
      for(let i=1;i<=4;i++){
        const id = `${key}_${i}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}" data-key="${key}" data-idx="${i}"><span>${i}</span>`;
        div.appendChild(label);
      }
    });

    let currentZone = null;

    function openModalForZone(zoneId){
      currentZone = zoneId;
      $('#modalTitle').textContent = `Zone ${zoneId}`;
      // reset
      zoneForm.reset();
      photoPreview.innerHTML = '<span class="muted">Aucune image</span>';
      // load data
      const data = loadZoneData(zoneId);
      if(data){
        // checks
        KEYS.forEach(k=>{
          const arr = data[k] || [false,false,false,false];
          arr.forEach((v,idx)=>{
            const cb = document.querySelector(`input[data-key="${k}"][data-idx="${idx+1}"]`);
            if(cb) cb.checked = !!v;
          });
        });
        // photo
        if(data.photo){
          const img = document.createElement('img'); img.src = data.photo; photoPreview.innerHTML=''; photoPreview.appendChild(img);
        }
        photoComment.value = data.photoComment || '';
      }
      updateLiveScore();
      modal.showModal();
    }

    $$('#zones-group > g.zone').forEach(g=>{
      g.addEventListener('click', ()=> openModalForZone(g.id));
      g.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openModalForZone(g.id);} });
    });

    function updateLiveScore(){
      const temp = {};
      KEYS.forEach(k=>{
        temp[k] = Array.from(document.querySelectorAll(`input[data-key="${k}"]`)).map(cb=>cb.checked);
      });
      const score = formatScore(temp);
      zoneScoreEl.textContent = Math.round(score*100)/100;
    }

    zoneForm.addEventListener('change', (e)=>{
      if(e.target.matches('input[type="checkbox"]')) updateLiveScore();
    });

    // Preview image
    photoInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file){ photoPreview.innerHTML = '<span class="muted">Aucune image</span>'; return; }
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = document.createElement('img'); img.src = reader.result; photoPreview.innerHTML=''; photoPreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });

    // Save
    $('#saveBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      if(!currentZone) return;
      const payload = { _zone: currentZone };
      KEYS.forEach(k=>{
        payload[k] = Array.from(document.querySelectorAll(`input[data-key="${k}"]`)).map(cb=>cb.checked);
      });
      payload._score = formatScore(payload);
      payload._complete = KEYS.every(k=> (payload[k]||[]).some(v=>v)); // au moins 1 case dans chaque cat√©gorie
      // photo
      const previewImg = photoPreview.querySelector('img');
      payload.photo = previewImg ? previewImg.src : null;
      payload.photoComment = photoComment.value || '';
      saveZoneData(currentZone, payload);
      modal.close();
      refreshZoneStyles();
    });

    // Delete only this zone
    $('#deleteZone').addEventListener('click', ()=>{
      if(!currentZone) return;
      if(confirm(`Supprimer les donn√©es pour ${currentZone} ?`)){
        deleteZoneData(currentZone);
        refreshZoneStyles();
        modal.close();
      }
    });

    // Close
    $('#closeModal').addEventListener('click', (e)=>{ e.preventDefault(); modal.close(); });

    // Export JSON
    function download(name, data, type='application/json'){
      const blob = new Blob([data], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    $('#exportJson').addEventListener('click', ()=>{
      const all = listAllZones().map(z=> ({ zone:z, data: loadZoneData(z) }));
      download(`tournee_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(all, null, 2));
    });

    // Export CSV
    $('#exportCsv').addEventListener('click', ()=>{
      const rows = [['zone','proprete(0-4)','affiches(0-4)','accessibilite(0-4)','tri(0-4)','bennes(0-4)','depart(0-4)','score','complete','photoComment']];
      listAllZones().forEach(z=>{
        const d = loadZoneData(z) || {};
        const toN = k => (d[k]||[]).filter(Boolean).length;
        rows.push([z, toN('proprete'), toN('affiches'), toN('accessibilite'), toN('tri'), toN('bennes'), toN('depart'), d._score||0, d._complete?1:0, (d.photoComment||'').replace(/\n/g,' ') ]);
      });
      const csv = rows.map(r=> r.map(v=> String(v).includes(',')?`"${String(v).replaceAll('"','""')}"`:v).join(',')).join('\n');
      download(`tournee_${new Date().toISOString().slice(0,10)}.csv`, csv, 'text/csv');
    });

    // Reset all
    $('#resetAll').addEventListener('click', ()=>{
      if(!confirm('Tout effacer ?')) return;
      listAllZones().forEach(z=> deleteZoneData(z));
      refreshZoneStyles();
    });

    // Init
    buildSidebar();
  </script>
</body>
</html>

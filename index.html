<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TICP • Localisation & Notation Déchets</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{--brand:#E6007E;--brand-700:#b80063;--bg:#f6f7fb;--panel:#fff;--text:#1f2a37;--muted:#6b7280;--line:#e5e7eb;--ok:#16a34a;--ok-200:#dcfce7}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}

  .app{display:grid;grid-template-rows:auto 1fr;height:100%}
  header.appbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
  .bar{max-width:1600px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo{width:10px;height:28px;border-radius:999px;background:var(--brand);box-shadow:0 0 0 6px rgba(230,0,126,.08)}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#eef2ff;color:#3730a3}
  .btn{appearance:none;border:none;border-radius:10px;cursor:pointer;padding:10px 14px;font-weight:600;background:var(--brand);color:#fff;box-shadow:0 8px 22px rgba(230,0,126,.22);transition:.2s}
  .btn:hover{background:var(--brand-700);transform:translateY(-1px)}
  .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:8px 10px;border-radius:8px;font-size:12px}

  /* Panneau au-dessus (mobile), tiroir (desktop) */
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:0 0 16px 16px;box-shadow:0 10px 30px rgba(2,8,23,.06);margin:0 0 12px 0}
  .panel>header{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .panel>.content{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .field{display:grid;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,.choices__inner{width:100%}

  /* Carte : image positionnée par left/top, mise à l’échelle via width/height (AUCUNE transform CSS) */
  .mapwrap{position:relative;width:100%;background:#0b1020}
  .mapimg{position:absolute;left:0;top:0;user-select:none;-webkit-user-drag:none}
  canvas#overlay{position:absolute;left:0;top:0;pointer-events:none}

  .toolbox{position:absolute;left:12px;top:12px;z-index:5;display:flex;gap:8px;flex-wrap:wrap}
  .hud{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px;z-index:5}
  .card{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:170px;color:#111827}
  .kpi{font-size:12px;color:#6b7280;display:flex;gap:6px;align-items:center}
  .kpi strong{font-size:13px;color:#111827}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999}
  .toast.show{opacity:1}

  /* Desktop : carte plein écran, panneau tiroir */
  @media (min-width:1025px){
    .mapwrap{height:calc(100vh - 64px)}
    .panel{
      position:fixed; inset:64px 0 0 auto;
      width:420px; max-width:92vw; border-radius:0;
      transform:translateX(100%); transition:transform .25s ease;
      border-left:1px solid var(--line); border-right:none; margin:0;
      z-index:40; box-shadow:-20px 0 50px rgba(2,8,23,.15);
    }
    .panel.open{ transform:translateX(0) }
    .panel .close{ display:inline-flex }
  }

  /* Mobile/Tablet : panneau en haut + carte 70vh */
  @media (max-width:1024px){
    .mapwrap{height:70vh;min-height:520px;border-radius:16px}
    .panel .close{ display:none }
  }

  /* Modal notation */
  dialog{border:none;border-radius:14px;max-width:min(820px,96vw);width:100%;padding:0;box-shadow:0 30px 80px rgba(2,6,23,.4)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .mod{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .mod-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700}
  .mod-bd{padding:14px;display:grid;gap:12px}
  .mod-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .cardX{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .cardX h4{margin:0 0 8px;font-size:13px;color:#374151}
  .checks{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .checks label{display:flex;gap:6px;align-items:center;border:1px dashed #cbd5e1;border-radius:10px;padding:8px}
  .checks input{width:16px;height:16px}
  .muted{color:var(--muted);font-size:12px}
  .preview{display:grid;place-items:center;min-height:120px;border:1px dashed #cbd5e1;border-radius:10px;overflow:hidden}
  .preview img{max-width:100%;max-height:260px;display:block}
  textarea{min-height:84px;width:100%;resize:vertical;border:1px solid var(--line);border-radius:10px;padding:10px}
  .mod-ft{display:flex;justify-content:space-between;gap:8px;padding:12px 14px;border-top:1px solid var(--line);background:#fafafa}
  .pill-ok{display:inline-flex;align-items:center;gap:6px;background:var(--ok-200);color:#065f46;border:1px solid #86efac;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="bar">
      <div class="brand"><div class="logo"></div>TICP • Localisation & Notation des déchets</div>
      <div class="row">
        <button class="btn secondary small" id="btnTogglePanel">Panneau</button>
        <button class="btn secondary small" id="btnExportCsv">Export CSV</button>
        <button class="btn secondary small" id="btnExportJson">Export JSON</button>
        <button class="btn secondary small" id="btnResetAll">Réinitialiser</button>
        <span class="chip" id="chipGps">GPS: off</span>
        <span class="chip" id="chipCompass">Boussole: off</span>
      </div>
    </div>
  </header>

  <main>
    <!-- Panneau AU-DESSUS (mobile), tiroir (desktop) -->
    <section class="panel" id="panel">
      <header>
        Navigation & Recherche
        <button class="btn secondary small close" id="btnClosePanel" style="display:none">Fermer</button>
      </header>
      <div class="content grid">
        <div class="field">
          <label>Origine</label>
          <div class="row">
            <button class="btn small" id="btnGPS">Activer GPS + Boussole</button>
            <button class="btn secondary small" id="btnPick">Choisir sur le plan</button>
            <button class="btn secondary small" id="btnCalibrate">Calibrer boussole</button>
            <button class="btn secondary small" id="btnNudgeMinus">-5°</button>
            <button class="btn secondary small" id="btnNudgePlus">+5°</button>
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="zoneSelect">Emplacement</label>
            <select id="zoneSelect" placeholder="Rechercher un emplacement"></select>
          </div>
          <div class="field">
            <label for="dechetSelect">Déchet</label>
            <select id="dechetSelect" placeholder="Rechercher un déchet"></select>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnOK">Tracer</button>
          <button class="btn secondary" id="btnClear">Effacer</button>
        </div>

        <div class="field">
          <label>Déchets dans la zone</label>
          <ul id="dechetList" style="padding-left:18px;margin:6px 0 0 0"><li>Aucune zone sélectionnée</li></ul>
        </div>
        <div class="field">
          <span class="muted">Astuce : cliquez un point vert/rouge sur la carte (proche d'une Z*) pour ouvrir la fiche de notation.</span>
        </div>
      </div>
    </section>

    <!-- Carte -->
    <section class="mapwrap" id="mapContainer">
      <img id="mapImage" class="mapimg" src="1.png" alt="Plan du site" draggable="false"/>
      <canvas id="overlay"></canvas>

      <div class="toolbox">
        <button class="btn secondary small" id="zMinus">–</button>
        <button class="btn secondary small" id="zReset">100%</button>
        <button class="btn secondary small" id="zPlus">+</button>
        <button class="btn secondary small" id="btnFit">Ajuster</button>
      </div>

      <div class="hud">
        <div class="card">
          <div class="kpi">Position <strong id="kpiPos">—</strong></div>
          <div class="kpi">Cap <strong id="kpiHead">—</strong></div>
          <div class="kpi">Zoom <strong id="kpiZoom">100%</strong></div>
          <div class="kpi">Zone <strong id="kpiZone">—</strong></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modal Notation Zone -->
<dialog id="rateModal">
  <form method="dialog" class="mod" id="rateForm">
    <div class="mod-hd">
      <div>Notation – <span id="rateTitle">Zone</span> <span id="statusPill" class="pill-ok" style="display:none">Complète</span></div>
      <button class="btn secondary small" id="btnCloseRate">Fermer</button>
    </div>
    <div class="mod-bd">
      <div class="mod-grid">
        <div class="cardX">
          <h4>Propreté de la zone (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="proprete"></div>
        </div>
        <div class="cardX">
          <h4>Présence & état des affiches (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="affiches"></div>
        </div>
        <div class="cardX">
          <h4>Accessibilité des contenants (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="accessibilite"></div>
        </div>
        <div class="cardX">
          <h4>Respect du tri (sur 25)</h4>
          <div class="checks" data-weight="25" data-key="tri"></div>
        </div>
        <div class="cardX">
          <h4>État des bennes (sur 20)</h4>
          <div class="checks" data-weight="20" data-key="bennes"></div>
        </div>
        <div class="cardX">
          <h4>Départ des contenants (sur 10)</h4>
          <div class="checks" data-weight="10" data-key="depart"></div>
        </div>
      </div>

      <div class="cardX">
        <h4>Photo & commentaire</h4>
        <div class="preview" id="photoPreview"><span class="muted">Aucune image</span></div>
        <input type="file" id="photoInput" accept="image/*"/>
        <textarea id="photoComment" placeholder="Commentaire sur la photo (ex: emplacement, anomalie, n° benne…)"></textarea>
      </div>

      <div class="cardX">
        <h4>Récapitulatif</h4>
        <div class="muted">Cochez 0–4 cases par catégorie. Chaque case vaut un quart du total de la catégorie.</div>
        <p><strong>Score :</strong> <span id="zoneScore">0</span> / <span id="zoneMax">85</span></p>
      </div>
    </div>
    <div class="mod-ft">
      <span class="muted">Données stockées dans le navigateur.</span>
      <div class="row">
        <button class="btn secondary small" id="btnDeleteZone">Effacer la zone</button>
        <button class="btn small" id="btnSaveRate">Enregistrer</button>
      </div>
    </div>
  </form>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
/***** SAFE MODE v1 – compat + debug *****/
(function(){
  var bootEl = document.createElement('div');
  bootEl.id='debugBar';
  bootEl.style.cssText='position:fixed;left:12px;bottom:12px;z-index:9999;background:#111;color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.2 monospace;opacity:.9';
  bootEl.textContent='JS: booting…';
  document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(bootEl); });

  function setDebug(msg){ try{ bootEl.textContent = 'JS: '+msg; }catch(e){}
    try{ console.log('[DEBUG]', msg); }catch(e){}
  }

  window.addEventListener('error', function(e){
    setDebug('ERROR → '+(e.message||'see console'));
  });

  /* ---- Polyfill <dialog> minimal ---- */
  function ensureDialogPolyfill(){
    var dlg = document.getElementById('rateModal');
    if(!dlg) return;
    if (typeof window.HTMLDialogElement === 'undefined' || !('showModal' in HTMLDialogElement.prototype)){
      setDebug('dialog polyfill active');
      var backdrop = document.createElement('div');
      backdrop.id='dlgBackdrop';
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:60';
      document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(backdrop); });
      dlg.style.position='fixed'; dlg.style.zIndex='61'; dlg.style.left='50%'; dlg.style.top='50%'; dlg.style.transform='translate(-50%,-50%)'; dlg.style.display='none';
      dlg.showModal = function(){ dlg.style.display='block'; backdrop.style.display='block'; };
      dlg.close = function(){ dlg.style.display='none'; backdrop.style.display='none'; };
    } else {
      setDebug('dialog native');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    setDebug('DOMContentLoaded');

    /* ===== Helpers ===== */
    function $(q){ return document.querySelector(q); }
    function toast(msg){ var t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(function(){t.classList.remove('show');},1800); }

    ensureDialogPolyfill();

    /* ===== Panneau ===== */
    var panel = $('#panel');
    $('#btnTogglePanel').addEventListener('click', function(){ panel.classList.toggle('open'); });
    $('#btnClosePanel').addEventListener('click', function(){ panel.classList.remove('open'); });

    /* ===== Données (version sans optional chaining) ===== */
    var coords = JSON.parse(decodeURIComponent('%7B%22MR5%20Atelier2%22%3A%7B%22x%22%3A243%2C%22y%22%3A684%7D%2C%22MR15%22%3A%7B%22x%22%3A301%2C%22y%22%3A606%7D%2C%22MR13%22%3A%7B%22x%22%3A312%2C%22y%22%3A577%7D%2C%22MR6%20Enduis%20et%20Peinture%22%3A%7B%22x%22%3A400%2C%22y%22%3A600%7D%2C%22MR13%20Atelier%204%22%3A%7B%22x%22%3A392%2C%22y%22%3A648%7D%2C%22MR1%22%3A%7B%22x%22%3A392%2C%22y%22%3A704%7D%2C%22MR13%20Atelier5%22%3A%7B%22x%22%3A461%2C%22y%22%3A728%7D%2C%22MR5%20Atelier23%22%3A%7B%22x%22%3A369%2C%22y%22%3A763%7D%2C%22MR3%20Voie%2035D%22%3A%7B%22x%22%3A552%2C%22y%22%3A554%7D%2C%22MR6%20KD%20Lavage%22%3A%7B%22x%22%3A536%2C%22y%22%3A505%7D%2C%22MR4%20Atelier6%22%3A%7B%22x%22%3A854%2C%22y%22%3A419%7D%2C%22BUMR%22%3A%7B%22x%22%3A790%2C%22y%22%3A460%7D%2C%22MR2%20-%20MR13%22%3A%7B%22x%22%3A680%2C%22y%22%3A665%7D%2C%22MR2%20Porte%22%3A%7B%22x%22%3A665%2C%22y%22%3A711%7D%2C%22MR2%20Fen%C3%AAtre%22%3A%7B%22x%22%3A670%2C%22y%22%3A747%7D%2C%22MR2%20Etabli%22%3A%7B%22x%22%3A738%2C%22y%22%3A747%7D%2C%22MR3%22%3A%7B%22x%22%3A774%2C%22y%22%3A659%7D%2C%22MR2%20HUB%22%3A%7B%22x%22%3A852%2C%22y%22%3A685%7D%2C%22MR7%20Peinture%20%2B%20pon%C3%A7age%22%3A%7B%22x%22%3A953%2C%22y%22%3A607%7D%2C%22MR7%20pr%C3%A9paration%22%3A%7B%22x%22%3A934%2C%22y%22%3A749%7D%2C%22CABOUT%22%3A%7B%22x%22%3A1034%2C%22y%22%3A688%7D%2C%22PRM11%22%3A%7B%22x%22%3A1028%2C%22y%22%3A745%7D%2C%22PRM4%22%3A%7B%22x%22%3A1189%2C%22y%22%3A747%7D%2C%22PRM5%20Compresseur%22%3A%7B%22x%22%3A1258%2C%22y%22%3A692%7D%2C%22PRM10%20Rechauffeur%22%3A%7B%22x%22%3A1325%2C%22y%22%3A678%7D%2C%22PRM1%20MVT%22%3A%7B%22x%22%3A1321%2C%22y%22%3A740%7D%2C%22PRM3%22%3A%7B%22x%22%3A1336%2C%22y%22%3A532%7D%2C%22PRM2%22%3A%7B%22x%22%3A1322%2C%22y%22%3A428%7D%2C%22PRM7%20Atelier12%22%3A%7B%22x%22%3A1280%2C%22y%22%3A345%7D%2C%22PRM6%20CAPA%22%3A%7B%22x%22%3A1203%2C%22y%22%3A331%7D%2C%22PRM6%20Blow%20WC%22%3A%7B%22x%22%3A1496%2C%22y%22%3A730%7D%2C%22PRM6%20Pi%C3%A8ces%20sanitaire%22%3A%7B%22x%22%3A1474%2C%22y%22%3A665%7D%2C%22PRM6%20Lavage%22%3A%7B%22x%22%3A1468%2C%22y%22%3A608%7D%2C%22SC2%20Amont%20CT10%22%3A%7B%22x%22%3A1452%2C%22y%22%3A490%7D%2C%22SC2%20Magasin%22%3A%7B%22x%22%3A1596%2C%22y%22%3A499%7D%2C%22SC2%20R%C3%A9ception%22%3A%7B%22x%22%3A1527%2C%22y%22%3A420%7D%2C%22SC%20Kitting%22%3A%7B%22x%22%3A1534%2C%22y%22%3A355%7D%2C%22MR8%20Grenailleuse%22%3A%7B%22x%22%3A1504%2C%22y%22%3A249%7D%2C%22Bogies%22%3A%7B%22x%22%3A1670%2C%22y%22%3A287%7D%2C%22MABOR%22%3A%7B%22x%22%3A1804%2C%22y%22%3A282%7D%2C%22PRM8%22%3A%7B%22x%22%3A1732%2C%22y%22%3A733%7D%2C%22Z1%22%3A%7B%22x%22%3A1875%2C%22y%22%3A584%7D%2C%22Z2%22%3A%7B%22x%22%3A1814%2C%22y%22%3A755%7D%2C%22Z3%22%3A%7B%22x%22%3A1768%2C%22y%22%3A366%7D%2C%22Z4%22%3A%7B%22x%22%3A1634%2C%22y%22%3A379%7D%2C%22Z5%22%3A%7B%22x%22%3A1602%2C%22y%22%3A182%7D%2C%22Z6%22%3A%7B%22x%22%3A1416%2C%22y%22%3A382%7D%2C%22Z7%22%3A%7B%22x%22%3A1529%2C%22y%22%3A492%7D%2C%22Z8%22%3A%7B%22x%22%3A1415%2C%22y%22%3A448%7D%2C%22Z9%22%3A%7B%22x%22%3A1419%2C%22y%22%3A617%7D%2C%22Z10%22%3A%7B%22x%22%3A1590%2C%22y%22%3A676%7D%2C%22Z11%22%3A%7B%22x%22%3A1415%2C%22y%22%3A734%7D%2C%22Z12%22%3A%7B%22x%22%3A1205%2C%22y%22%3A204%7D%2C%22Z13%22%3A%7B%22x%22%3A1285%2C%22y%22%3A412%7D%2C%22Z14%22%3A%7B%22x%22%3A1111%2C%22y%22%3A371%7D%2C%22Z15%22%3A%7B%22x%22%3A1200%2C%22y%22%3A603%7D%2C%22Z16%22%3A%7B%22x%22%3A1026%2C%22y%22%3A620%7D%2C%22Z17%22%3A%7B%22x%22%3A1122%2C%22y%22%3A644%7D%2C%22Z18%22%3A%7B%22x%22%3A1048%2C%22y%22%3A544%7D%2C%22Z19%22%3A%7B%22x%22%3A921%2C%22y%22%3A329%7D%2C%22Z20%22%3A%7B%22x%22%3A834%2C%22y%22%3A378%7D%2C%22Z21%22%3A%7B%22x%22%3A710%2C%22y%22%3A415%7D%2C%22Z22%22%3A%7B%22x%22%3A704%2C%22y%22%3A600%7D%2C%22Z23%22%3A%7B%22x%22%3A865%2C%22y%22%3A608%7D%2C%22Z24%22%3A%7B%22x%22%3A735%2C%22y%22%3A714%7D%2C%22Z25%22%3A%7B%22x%22%3A965%2C%22y%22%3A728%7D%2C%22Z26%22%3A%7B%22x%22%3A785%2C%22y%22%3A791%7D%2C%22Z27%22%3A%7B%22x%22%3A602%2C%22y%22%3A788%7D%2C%22Z28%22%3A%7B%22x%22%3A478%2C%22y%22%3A433%7D%2C%22Z29%22%3A%7B%22x%22%3A442%2C%22y%22%3A511%7D%2C%22Z30%22%3A%7B%22x%22%3A317%2C%22y%22%3A547%7D%2C%22Z31%22%3A%7B%22x%22%3A212%2C%22y%22%3A600%7D%2C%22Z32%22%3A%7B%22x%22%3A1156%2C%22y%22%3A738%7D%2C%22Z33%22%3A%7B%22x%22%3A292%2C%22y%22%3A689%7D%2C%22Z34%22%3A%7B%22x%22%3A511%2C%22y%22%3A685%7D%2C%22Z35%22%3A%7B%22x%22%3A1534%2C%22y%22%3A329%7D%2C%22Z36%22%3A%7B%22x%22%3A1119%2C%22y%22%3A598%7D%2C%22Bureau%20Administratif%22%3A%7B%22x%22%3A1524%2C%22y%22%3A152%7D%7D'));
    var dechetsParZone = JSON.parse(decodeURIComponent('%7B%22Z1%22%3A%5B%22Bois%22%2C%22Carton%22%2C%22Bac%20noir%22%2C%22Plastique%22%5D%2C%22Z2%22%3A%5B%22Ferreux%22%2C%22Cuivre%22%2C%22Non%20ferreux%22%2C%22Caoutchouc%22%2C%22Bois%22%2C%22Carton%22%2C%22Condenseur%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22A%C3%A9rosols%22%2C%22DEEE%22%5D%2C%22Z3%22%3A%5B%22Carton%22%2C%22Bois%22%2C%22R%C3%A9hausses%20KC%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Ferreux%22%2C%22Caoutchouc%22%2C%22A%C3%A9rosols%22%2C%22P%C3%A9lican%22%2C%22Huile%20usag%C3%A9es%22%5D%2C%22Z4%22%3A%5B%22Carton%22%2C%22Bois%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Bac%20noir%22%2C%22Polystyr%C3%A8ne%22%2C%22R%C3%A9hausses%20KC%22%5D%2C%22Z5%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22Carton%22%2C%22Cartouche%20d'encre%22%5D%2C%22Z6%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%5D%2C%22Z7%22%3A%5B%22Bac%20noir%22%2C%22Plastique%22%5D%2C%22Z8%22%3A%5B%22Bois%22%2C%22Carton%22%2C%22Ferreux%22%2C%22Polystyr%C3%A8ne%22%2C%22Plastique%22%2C%22Bac%20jaune%22%2C%22Bac%20noir%22%5D%2C%22Z9%22%3A%5B%22Carton%22%2C%22Bois%22%2C%22Bac%20noir%22%2C%22R%C3%A9hausses%20KC%22%5D%2C%22Z10%22%3A%5B%22A%C3%A9rosols%22%2C%22Bac%20noir%22%2C%22Non%20ferreux%22%2C%22Carton%22%5D%2C%22Z11%22%3A%5B%22Carton%22%2C%22Bois%22%2C%22Polystyr%C3%A8ne%22%2C%22Plastique%22%2C%22DEEE%22%2C%22Non%20ferreux%22%2C%22R%C3%A9hausses%20KC%22%2C%22A%C3%A9rosols%22%2C%22P%C3%A9lican%22%2C%22Bac%20jaune%22%2C%22Ferreux%22%2C%22Caoutchouc%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%5D%2C%22Z12%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%5D%2C%22Z13%22%3A%5B%22Piles%20et%20Accumulateur%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22A%C3%A9rosols%22%2C%22Ferreux%22%2C%22Cuivre%22%2C%22Non%20ferreux%22%2C%22DEEE%22%2C%22Caoutchouc%22%2C%22Huile%20usag%C3%A9es%22%5D%2C%22Z14%22%3A%5B%22A%C3%A9rosols%22%2C%22Ferreux%22%2C%22Non%20ferreux%22%2C%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Carton%22%2C%22Bois%22%2C%22R%C3%A9hausses%20KC%22%5D%2C%22Z15%22%3A%5B%22DEEE%22%2C%22Carton%22%2C%22Non%20ferreux%22%2C%22Ferreux%22%2C%22Plastique%22%2C%22Polystyr%C3%A8ne%22%2C%22Bac%20noir%22%5D%2C%22Z16%22%3A%5B%22Piles%20et%20Accumulateur%22%2C%22Cartouche%20d'encre%22%2C%22V%C3%AAtements%20usag%C3%A9es%22%2C%22Bac%20noir%22%2C%22A%C3%A9rosols%22%2C%22DEEE%22%2C%22Carton%22%2C%22Bac%20jaune%22%5D%2C%22Z17%22%3A%5B%22DEEE%22%2C%22A%C3%A9rosols%22%2C%22Bac%20noir%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Huile%20usag%C3%A9es%22%5D%2C%22Z18%22%3A%5B%22Bois%22%2C%22Carton%22%2C%22Ferreux%22%2C%22Non%20ferreux%22%2C%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22Verre%22%2C%22D%C3%A9chets%20non%20dangereux%22%5D%2C%22Z19%22%3A%5B%22Bac%20noir%22%5D%2C%22Z20%22%3A%5B%22Ferreux%22%2C%22Non%20ferreux%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Bois%22%2C%22Carton%22%2C%22Plastique%22%2C%22Bac%20plomb%22%5D%2C%22Z21%22%3A%5B%22Verre%22%2C%22Bois%22%2C%22Carton%22%2C%22Ferreux%22%2C%22Non%20ferreux%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Plastique%22%2C%22Polystyr%C3%A8ne%22%2C%22DEEE%22%2C%22P%C3%A9lican%22%2C%22Bac%20jaune%22%2C%22GRV%20Huiles%22%2C%22GRV%20Cool%20Elf%22%5D%2C%22Z22%22%3A%5B%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22F%C3%BBt%20peinture%22%5D%2C%22Z23%22%3A%5B%22Ampoules%22%2C%22N%C3%A9ons%22%2C%22A%C3%A9rosols%22%2C%22Bac%20noir%22%2C%22Bac%20jaune%22%5D%2C%22Z24%22%3A%5B%22Caoutchouc%22%2C%22P%C3%A9lican%22%2C%22Verre%22%5D%2C%22Z25%22%3A%5B%22Geobox%20D%C3%A9chets%20dangereux%22%5D%2C%22Z26%22%3A%5B%22Carton%22%2C%22Bois%22%5D%2C%22Z27%22%3A%5B%22Bois%22%2C%22Carton%22%2C%22Ferreux%22%2C%22Non%20ferreux%22%2C%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Plastique%22%2C%22Polystyr%C3%A8ne%22%2C%22A%C3%A9rosols%22%5D%2C%22Z28%22%3A%5B%22Ferreux%22%2C%22Bac%20noir%22%2C%22F%C3%BBt%20filtres%22%2C%22Huile%20usag%C3%A9es%22%5D%2C%22Z29%22%3A%5B%22Geobox%20D%C3%A9chets%20dangereux%22%5D%2C%22Z30%22%3A%5B%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22P%C3%A9lican%22%2C%22Bac%20jaune%22%2C%22Carton%22%2C%22Bois%22%2C%22DEEE%22%2C%22Non%20ferreux%22%2C%22Ferreux%22%2C%22A%C3%A9rosols%22%2C%22Amiante%22%5D%2C%22Z31%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22Amiante%22%5D%2C%22Z32%22%3A%5B%22Geobox%20D%C3%A9chets%20dangereux%22%2C%22Non%20ferreux%22%2C%22Ferreux%22%5D%2C%22Z33%22%3A%5B%22Amiante%22%5D%2C%22Z34%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%5D%2C%22Z35%22%3A%5B%22Bac%20noir%22%2C%22Bac%20jaune%22%2C%22Plastique%22%2C%22Carton%22%5D%7D'));

    /* ===== UI selects (fallback sans Choices si CDN bloqué) ===== */
    var zoneSel = $('#zoneSelect'), dechSel=$('#dechetSelect');
    var zoneOpts = ['Ma localisation'];
    Object.keys(coords).forEach(function(k){ if(k.indexOf('Z')!==0) zoneOpts.push(k); });
    zoneSel.innerHTML = zoneOpts.map(function(v){return '<option value="'+v+'">'+v+'</option>';}).join('');
    var allTypes = []; Object.keys(dechetsParZone).forEach(function(z){ dechetsParZone[z].forEach(function(t){ if(allTypes.indexOf(t)===-1) allTypes.push(t); }); }); allTypes.sort();
    dechSel.innerHTML = allTypes.map(function(v){return '<option value="'+v+'">'+v+'</option>';}).join('');

    if (typeof Choices==='function'){
      try{ new Choices(zoneSel,{searchEnabled:true,shouldSort:false,itemSelectText:''}); new Choices(dechSel,{searchEnabled:true,shouldSort:true,itemSelectText:''}); }catch(err){ setDebug('Choices err: '+err.message); }
    }

    zoneSel.addEventListener('change', function(e){
      var z=e.target.value; var ul=$('#dechetList'); ul.innerHTML=''; var arr=(dechetsParZone[z]||[]).slice().sort();
      if(!arr.length) ul.innerHTML='<li>Aucun déchet</li>'; else arr.forEach(function(t){ var li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      $('#kpiZone').textContent = z || '—';
    });

    /* ===== Carte & dessin minimal pour valider les boutons ===== */
    var mapContainer=$('#mapContainer'); var mapImg=$('#mapImage'); var canvas=$('#overlay'); var ctx=canvas.getContext('2d');
    var base={s:1,ox:0,oy:0,iw:1,ih:1}; var view={z:1,panX:0,panY:0}; var dragging=false,lx=0,ly=0;
    function computeFit(){ var r=mapContainer.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; base.iw=mapImg.naturalWidth||1; base.ih=mapImg.naturalHeight||1; var s=Math.min(r.width/base.iw, r.height/base.ih); base.s=s; base.ox=(r.width-base.iw*s)/2; base.oy=(r.height-base.ih*s)/2; }
    function applyLayout(){ var w=base.iw*base.s*view.z, h=base.ih*base.s*view.z; mapImg.style.width=w+'px'; mapImg.style.height=h+'px'; mapImg.style.left=(base.ox+view.panX)+'px'; mapImg.style.top=(base.oy+view.panY)+'px'; $('#kpiZoom').textContent=Math.round(view.z*100)+'%'; }
    function imgToScreen(pt){ return {x:(base.ox+view.panX)+pt.x*(base.s*view.z), y:(base.oy+view.panY)+pt.y*(base.s*view.z)}; }
    function drawAll(){ ctx.clearRect(0,0,canvas.width,canvas.height); /* markers Z */ Object.keys(coords).forEach(function(k){ if(k.indexOf('Z')===0){ var p=imgToScreen(coords[k]); ctx.beginPath(); ctx.arc(p.x,p.y,10,0,Math.PI*2); ctx.fillStyle='rgba(239,68,68,.15)'; ctx.fill(); ctx.strokeStyle='#ef4444'; ctx.stroke(); } }); }
    function fitAndCenter(){ computeFit(); view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); }
    new ResizeObserver(function(){ fitAndCenter(); }).observe(mapContainer);
    mapImg.addEventListener('load', fitAndCenter); if(mapImg.complete) setTimeout(fitAndCenter,0);

    document.getElementById('zPlus').onclick  = function(){ view.z+=0.12; applyLayout(); drawAll(); setDebug('zPlus ok'); };
    document.getElementById('zMinus').onclick = function(){ view.z-=0.12; applyLayout(); drawAll(); setDebug('zMinus ok'); };
    document.getElementById('zReset').onclick = function(){ view.z=1; view.panX=0; view.panY=0; applyLayout(); drawAll(); setDebug('zReset ok'); };
    document.getElementById('btnFit').onclick = function(){ fitAndCenter(); setDebug('fit ok'); };

    /* ===== Notation : ouvrir modal au clic sur une Z* ===== */
    var rateModal = document.getElementById('rateModal'); var rateTitle=document.getElementById('rateTitle'); var zoneScoreEl=document.getElementById('zoneScore'); var statusPill=document.getElementById('statusPill');
    var KEYS=['proprete','affiches','accessibilite','tri','bennes','depart']; var WEIGHTS={proprete:10,affiches:10,accessibilite:10,tri:25,bennes:20,depart:10};
    Array.prototype.forEach.call(document.querySelectorAll('.checks'), function(div){ var key=div.getAttribute('data-key'); for(var i=1;i<=4;i++){ var lab=document.createElement('label'); lab.innerHTML='<input type="checkbox" data-key="'+key+'" data-idx="'+i+'"><span>'+i+'</span>'; div.appendChild(lab); } });
    function computeScore(){ var s=0; for(var k=0;k<KEYS.length;k++){ var key=KEYS[k]; var cbs=document.querySelectorAll('input[data-key="'+key+'"]'); var n=0; for(var i=0;i<cbs.length;i++){ if(cbs[i].checked) n++; } s += (WEIGHTS[key]/4)*n; } return s; }
    document.addEventListener('change', function(e){ if(e.target && e.target.matches('input[type="checkbox"][data-key]')){ var sc=computeScore(); zoneScoreEl.textContent = Math.round(sc*100)/100; var complete=true; for(var k=0;k<KEYS.length;k++){ var cbs=document.querySelectorAll('input[data-key="'+KEYS[k]+'"]'); var any=false; for(var i=0;i<cbs.length;i++){ if(cbs[i].checked){ any=true; break; } } if(!any) complete=false; } statusPill.style.display = complete?'inline-flex':'none'; }});

    mapContainer.addEventListener('click', function(e){ var rect=mapContainer.getBoundingClientRect(); var x=(e.clientX-rect.left - (base.ox+view.panX))/(base.s*view.z); var y=(e.clientY-rect.top  - (base.oy+view.panY))/(base.s*view.z); var nearest=null, dmin=1e9; Object.keys(coords).forEach(function(name){ if(name.indexOf('Z')===0){ var c=coords[name]; var d=Math.hypot(c.x-x,c.y-y); if(d<dmin){ dmin=d; nearest=name; } } }); if(nearest && dmin<=30/(base.s*view.z)){ rateTitle.textContent = nearest; if(rateModal && rateModal.showModal){ rateModal.showModal(); } else if(rateModal){ rateModal.style.display='block'; } setDebug('open '+nearest); }});

    document.getElementById('btnCloseRate').addEventListener('click', function(ev){ ev.preventDefault(); if(rateModal.close) rateModal.close(); else rateModal.style.display='none'; setDebug('modal close'); });

    /* ===== GPS toujours opérationnel (HTTPS/localhost) ===== */
    var chipGps=document.getElementById('chipGps'), kpiPos=document.getElementById('kpiPos');
    document.getElementById('btnGPS').addEventListener('click', function(){
      if(!navigator.geolocation){ toast('GPS non disponible'); setDebug('no geolocation'); return; }
      navigator.geolocation.getCurrentPosition(function(pos){
        var lat=pos.coords.latitude, lon=pos.coords.longitude; chipGps.textContent='GPS: on'; kpiPos.textContent=lat.toFixed(5)+', '+lon.toFixed(5); setDebug('GPS ok');
      }, function(err){ toast('Erreur GPS: '+err.message); setDebug('GPS error '+err.message); }, {enableHighAccuracy:true});
    });

    setDebug('READY');
  });
})();
</script>
</body>
</html>
